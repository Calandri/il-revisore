{% extends "base.html" %}

{% block title %}Live View - TurboWrap{% endblock %}

{% block content %}
<div class="h-full flex flex-col" x-data="liveViewPage()" x-init="init()">

    <!-- Header -->
    <div class="flex items-center justify-between mb-4 shrink-0">
        <div>
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <span>Live View</span>
                <span class="px-2 py-0.5 text-xs font-medium bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 rounded-full">Beta</span>
            </h1>
            <p class="text-gray-500 dark:text-gray-400">Visualizza e interagisci con i siti di produzione</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex gap-4 min-h-0">

        <!-- Left: Repository List -->
        <div class="w-72 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col shrink-0">
            <div class="p-3 border-b dark:border-gray-700">
                <h3 class="font-semibold text-sm">Repository Frontend</h3>
            </div>
            <div class="flex-1 overflow-y-auto p-2">
                <!-- Loading -->
                <div x-show="loadingRepos" class="flex items-center justify-center py-8">
                    <svg class="animate-spin w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>

                <!-- Empty state -->
                <div x-show="!loadingRepos && repos.length === 0" class="text-center py-8 text-gray-400 text-sm">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                    </svg>
                    <p>Nessun repository</p>
                    <p class="mt-1 text-xs">Aggiungi un link production nelle impostazioni del repository</p>
                </div>

                <!-- Repo list -->
                <div x-show="!loadingRepos && repos.length > 0" class="space-y-1">
                    <template x-for="repo in repos" :key="repo.id">
                        <button @click="selectRepo(repo)"
                                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left transition-colors"
                                :class="selectedRepo?.id === repo.id
                                    ? 'bg-primary/10 text-primary border border-primary/30'
                                    : 'hover:bg-gray-100 dark:hover:bg-gray-700'">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm shrink-0"
                                 x-text="repo.name.charAt(0).toUpperCase()"></div>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium truncate" x-text="repo.name"></div>
                                <div class="text-xs text-gray-400 truncate" x-text="repo.production_link.url"></div>
                            </div>
                            <span class="px-1.5 py-0.5 text-[10px] font-medium rounded"
                                  :class="repo.repo_type === 'frontend'
                                      ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300'
                                      : 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300'"
                                  x-text="repo.repo_type"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Right: Live View Panel -->
        <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden">

            <!-- No selection state -->
            <template x-if="!selectedRepo">
                <div class="flex-1 flex items-center justify-center text-gray-400">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        <p class="text-lg font-medium">Seleziona un repository</p>
                        <p class="text-sm mt-1">Scegli un repository dalla lista per visualizzare il sito live</p>
                    </div>
                </div>
            </template>

            <!-- Selected repo -->
            <template x-if="selectedRepo">
                <div class="flex flex-col h-full">
                    <!-- Header -->
                    <div class="p-3 border-b dark:border-gray-700 flex items-center justify-between shrink-0 bg-gray-50 dark:bg-gray-900">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm"
                                 x-text="selectedRepo.name.charAt(0).toUpperCase()"></div>
                            <div>
                                <h3 class="font-semibold" x-text="selectedRepo.name"></h3>
                                <a :href="selectedRepo.production_link.url" target="_blank"
                                   class="text-xs text-primary hover:underline flex items-center gap-1">
                                    <span x-text="selectedRepo.production_link.url"></span>
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Iframe status badge -->
                            <span x-show="iframeStatus === 'checking'" class="px-2 py-1 text-xs bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300 rounded-full flex items-center gap-1">
                                <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                </svg>
                                Verifica...
                            </span>
                            <span x-show="iframeStatus === 'allowed'" class="px-2 py-1 text-xs bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300 rounded-full">
                                Iframe OK
                            </span>
                            <span x-show="iframeStatus === 'blocked'" class="px-2 py-1 text-xs bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300 rounded-full">
                                Iframe Bloccato
                            </span>

                            <!-- Refresh screenshot button (only when blocked) -->
                            <button x-show="iframeStatus === 'blocked'"
                                    @click="captureScreenshot()"
                                    :disabled="capturingScreenshot"
                                    class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors disabled:opacity-50"
                                    title="Cattura nuovo screenshot">
                                <svg class="w-5 h-5" :class="capturingScreenshot ? 'animate-spin' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Content: Iframe or Screenshot -->
                    <div class="flex-1 relative overflow-hidden bg-white">
                        <!-- Loading -->
                        <div x-show="iframeStatus === 'checking'" class="absolute inset-0 flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                            <div class="text-center">
                                <svg class="animate-spin w-10 h-10 text-primary mx-auto mb-3" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="text-gray-500">Verifico compatibilita iframe...</p>
                            </div>
                        </div>

                        <!-- Iframe View (when allowed) -->
                        <iframe x-show="iframeStatus === 'allowed'"
                                x-ref="liveFrame"
                                :src="selectedRepo?.production_link.url"
                                class="w-full h-full border-0"
                                @load="setupIframeClickHandler()"></iframe>

                        <!-- Screenshot View (when blocked) -->
                        <div x-show="iframeStatus === 'blocked'" class="h-full flex flex-col">
                            <!-- Info banner -->
                            <div class="px-4 py-2 bg-amber-50 dark:bg-amber-900/20 border-b border-amber-200 dark:border-amber-800 text-sm text-amber-700 dark:text-amber-300 flex items-center gap-2 shrink-0">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span>Questo sito blocca l'embedding in iframe. Visualizzi uno screenshot.</span>
                                <a :href="selectedRepo?.production_link.url" target="_blank" class="ml-auto text-amber-800 dark:text-amber-200 hover:underline flex items-center gap-1">
                                    Apri sito
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>
                            </div>

                            <!-- Screenshot content -->
                            <div class="flex-1 overflow-auto p-4 bg-gray-100 dark:bg-gray-900">
                                <template x-if="screenshot">
                                    <img :src="screenshot.s3_url"
                                         alt="Screenshot del sito"
                                         class="max-w-full mx-auto shadow-xl rounded-lg border border-gray-300 dark:border-gray-600 cursor-crosshair"
                                         @click="handleScreenshotClick($event)">
                                </template>
                                <template x-if="!screenshot && !capturingScreenshot">
                                    <div class="h-full flex items-center justify-center">
                                        <div class="text-center">
                                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            </svg>
                                            <p class="text-gray-500 mb-4">Nessuno screenshot disponibile</p>
                                            <button @click="captureScreenshot()"
                                                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                                Cattura Screenshot
                                            </button>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="capturingScreenshot">
                                    <div class="h-full flex items-center justify-center">
                                        <div class="text-center">
                                            <svg class="animate-spin w-12 h-12 text-primary mx-auto mb-4" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                            </svg>
                                            <p class="text-gray-500">Cattura screenshot in corso...</p>
                                            <p class="text-xs text-gray-400 mt-1">Potrebbe richiedere alcuni secondi</p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Overlay hint -->
                        <div x-show="iframeStatus === 'allowed' && !selectedElement"
                             class="absolute bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-black/70 text-white text-sm rounded-full backdrop-blur-sm pointer-events-none">
                            Clicca su un elemento per creare un'issue o feature
                        </div>
                    </div>

                    <!-- Footer: Selected element info -->
                    <div x-show="selectedElement" class="p-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900 shrink-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="px-3 py-1.5 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 rounded-lg text-sm font-mono truncate max-w-md"
                                     x-text="selectedElement"></div>
                            </div>
                            <button @click="showActionModal = true"
                                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center gap-2 shrink-0">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                Azione
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Action Modal -->
    <div x-show="showActionModal"
         x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
         @click.self="showActionModal = false"
         @keydown.escape.window="showActionModal = false">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             @click.stop>
            <!-- Header -->
            <div class="p-4 border-b dark:border-gray-700 bg-gradient-to-r from-indigo-500 to-purple-500">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Cosa vuoi fare?
                </h3>
            </div>

            <!-- Content -->
            <div class="p-4 space-y-3">
                <!-- Selected element -->
                <div class="px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg font-mono text-sm text-indigo-600 dark:text-indigo-400 truncate"
                     x-text="selectedElement"></div>

                <!-- Title input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Titolo (opzionale)</label>
                    <input type="text" x-model="actionTitle"
                           class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="Descrivi brevemente il problema o la richiesta">
                </div>

                <!-- Description input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descrizione (opzionale)</label>
                    <textarea x-model="actionDescription" rows="2"
                              class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                              placeholder="Dettagli aggiuntivi..."></textarea>
                </div>
            </div>

            <!-- Actions -->
            <div class="p-4 border-t dark:border-gray-700 space-y-2">
                <!-- Create Issue -->
                <button @click="performAction('create_issue')"
                        :disabled="performingAction"
                        class="w-full px-4 py-3 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded-xl hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors flex items-center gap-3 disabled:opacity-50">
                    <div class="w-10 h-10 bg-red-100 dark:bg-red-900/50 rounded-lg flex items-center justify-center shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="text-left">
                        <div class="font-medium">Crea Issue</div>
                        <div class="text-xs opacity-70">Segnala un bug o problema</div>
                    </div>
                </button>

                <!-- Create Feature -->
                <button @click="performAction('create_feature')"
                        :disabled="performingAction"
                        class="w-full px-4 py-3 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-xl hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors flex items-center gap-3 disabled:opacity-50">
                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900/50 rounded-lg flex items-center justify-center shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                    </div>
                    <div class="text-left">
                        <div class="font-medium">Crea Feature</div>
                        <div class="text-xs opacity-70">Richiedi una nuova funzionalita</div>
                    </div>
                </button>

                <!-- Send to Chat -->
                <button @click="performAction('send_to_chat')"
                        :disabled="performingAction"
                        class="w-full px-4 py-3 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300 rounded-xl hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-colors flex items-center gap-3 disabled:opacity-50">
                    <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg flex items-center justify-center shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <div class="text-left">
                        <div class="font-medium">Invia alla Chat</div>
                        <div class="text-xs opacity-70">Discuti con l'AI assistant</div>
                    </div>
                </button>
            </div>

            <!-- Cancel -->
            <div class="px-4 pb-4">
                <button @click="showActionModal = false; actionTitle = ''; actionDescription = ''"
                        class="w-full px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors text-sm">
                    Annulla
                </button>
            </div>
        </div>
    </div>

</div>

<script>
function liveViewPage() {
    return {
        repos: [],
        loadingRepos: true,
        selectedRepo: null,
        iframeStatus: null, // 'checking', 'allowed', 'blocked'
        blockedReason: null,
        screenshot: null,
        capturingScreenshot: false,
        selectedElement: null,
        showActionModal: false,
        actionTitle: '',
        actionDescription: '',
        performingAction: false,

        async init() {
            await this.loadRepos();

            // Listen for element selection from iframe
            window.addEventListener('message', (e) => {
                if (e.data && e.data.type === 'liveview-element-selected') {
                    this.selectedElement = e.data.selector;
                }
            });
        },

        async loadRepos() {
            this.loadingRepos = true;
            try {
                const res = await fetch('/api/live-view/repos');
                if (res.ok) {
                    this.repos = await res.json();
                }
            } catch (e) {
                console.error('Failed to load repos:', e);
            } finally {
                this.loadingRepos = false;
            }
        },

        async selectRepo(repo) {
            this.selectedRepo = repo;
            this.selectedElement = null;
            this.screenshot = null;
            this.iframeStatus = 'checking';
            this.blockedReason = null;

            // Check iframe compatibility
            try {
                const res = await fetch(`/api/live-view/${repo.id}/check-iframe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: repo.production_link.url })
                });
                const data = await res.json();

                if (data.can_embed) {
                    this.iframeStatus = 'allowed';
                } else {
                    this.iframeStatus = 'blocked';
                    this.blockedReason = data.blocked_reason;
                    // Load existing screenshot if any
                    await this.loadScreenshot();
                }
            } catch (e) {
                console.error('Failed to check iframe:', e);
                this.iframeStatus = 'blocked';
                this.blockedReason = 'Check failed';
            }
        },

        async loadScreenshot() {
            if (!this.selectedRepo) return;
            try {
                const res = await fetch(`/api/live-view/${this.selectedRepo.id}/screenshot?external_link_id=${this.selectedRepo.production_link.id}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data) {
                        this.screenshot = data;
                    }
                }
            } catch (e) {
                console.error('Failed to load screenshot:', e);
            }
        },

        async captureScreenshot() {
            if (!this.selectedRepo) return;
            this.capturingScreenshot = true;

            try {
                const res = await fetch(`/api/live-view/${this.selectedRepo.id}/screenshot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        external_link_id: this.selectedRepo.production_link.id,
                        viewport_width: 1920,
                        viewport_height: 1080
                    })
                });

                if (res.ok) {
                    this.screenshot = await res.json();
                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: { message: 'Screenshot catturato!', type: 'success' }
                    }));
                } else {
                    const error = await res.json();
                    throw new Error(error.detail || 'Screenshot failed');
                }
            } catch (e) {
                console.error('Failed to capture screenshot:', e);
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { message: 'Errore: ' + e.message, type: 'error' }
                }));
            } finally {
                this.capturingScreenshot = false;
            }
        },

        setupIframeClickHandler() {
            const iframe = this.$refs.liveFrame;
            if (!iframe) return;

            // We can't inject scripts into cross-origin iframes
            // But we can show a hint and use postMessage if the site supports it
            // For now, just log that the iframe loaded
            console.log('[LiveView] Iframe loaded for:', this.selectedRepo?.production_link.url);

            // Note: Cross-origin iframe click handling requires cooperation from the target site
            // For full functionality, we'd need the target site to include our script
            // or use a proxy/screenshot approach
        },

        handleScreenshotClick(event) {
            // For screenshot mode, we can capture click coordinates
            // but can't get the actual DOM element
            const rect = event.target.getBoundingClientRect();
            const x = Math.round(((event.clientX - rect.left) / rect.width) * 100);
            const y = Math.round(((event.clientY - rect.top) / rect.height) * 100);

            this.selectedElement = `screenshot-click(${x}%, ${y}%)`;
        },

        async performAction(action) {
            if (!this.selectedRepo || !this.selectedElement) return;

            this.performingAction = true;
            try {
                const res = await fetch('/api/live-view/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        repository_id: this.selectedRepo.id,
                        action: action,
                        selector: this.selectedElement,
                        element_info: null,
                        title: this.actionTitle || null,
                        description: this.actionDescription || null
                    })
                });

                const data = await res.json();

                if (data.success) {
                    this.showActionModal = false;
                    this.actionTitle = '';
                    this.actionDescription = '';
                    this.selectedElement = null;

                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else if (data.command) {
                        // Open chat with command
                        window.dispatchEvent(new CustomEvent('open-chat-with-command', {
                            detail: { command: data.command, newSession: true }
                        }));
                    }

                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: { message: data.message || 'Azione completata!', type: 'success' }
                    }));
                } else {
                    throw new Error(data.message || 'Action failed');
                }
            } catch (e) {
                console.error('Action failed:', e);
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { message: 'Errore: ' + e.message, type: 'error' }
                }));
            } finally {
                this.performingAction = false;
            }
        }
    }
}
</script>
{% endblock %}
