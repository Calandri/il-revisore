{% extends "base.html" %}

{% block title %}{{ issue.issue_code }} - TurboWrap{% endblock %}

{% block head %}
<style>
.code-block { font-family: 'Monaco', 'Menlo', monospace; }
.severity-badge-critical { background: linear-gradient(135deg, #ef4444, #dc2626); }
.severity-badge-high { background: linear-gradient(135deg, #f97316, #ea580c); }
.severity-badge-medium { background: linear-gradient(135deg, #eab308, #ca8a04); }
.severity-badge-low { background: linear-gradient(135deg, #6b7280, #4b5563); }

.status-open { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-color: rgba(59, 130, 246, 0.3); }
.status-in_progress { background: rgba(168, 85, 247, 0.2); color: #c084fc; border-color: rgba(168, 85, 247, 0.3); }
.status-resolved { background: rgba(34, 197, 94, 0.2); color: #4ade80; border-color: rgba(34, 197, 94, 0.3); }
.status-merged { background: rgba(34, 197, 94, 0.2); color: #4ade80; border-color: rgba(34, 197, 94, 0.3); }
.status-in_review { background: rgba(234, 179, 8, 0.2); color: #facc15; border-color: rgba(234, 179, 8, 0.3); }
.status-ignored { background: rgba(107, 114, 128, 0.2); color: #9ca3af; border-color: rgba(107, 114, 128, 0.3); }
.status-duplicate { background: rgba(107, 114, 128, 0.2); color: #9ca3af; border-color: rgba(107, 114, 128, 0.3); }
</style>
{% endblock %}

{% block content %}
<div x-data="issueDetailApp()" x-init="init()">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-6">
        <div class="flex items-start gap-4">
            <!-- Back button -->
            <a href="/issues" class="mt-1 p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <div>
                <div class="flex flex-wrap items-center gap-3 mb-2">
                    <!-- Issue Code -->
                    <h1 class="text-2xl md:text-3xl font-bold font-mono">{{ issue.issue_code }}</h1>
                    <!-- Severity Badge -->
                    <span class="px-3 py-1 rounded-full text-sm font-bold text-white severity-badge-{{ issue.severity|lower }}">
                        {{ issue.severity }}
                    </span>
                    <!-- Status Badge -->
                    <span class="px-3 py-1 rounded-full text-sm font-medium border status-{{ issue.status }}">
                        {{ issue.status }}
                    </span>
                </div>
                <!-- Title -->
                <h2 class="text-xl text-gray-600 dark:text-gray-300">{{ issue.title }}</h2>
                <!-- Meta info -->
                <div class="flex flex-wrap items-center gap-4 mt-3 text-sm text-gray-500">
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        {{ issue.category }}
                    </span>
                    {% if issue.rule %}
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        Rule: {{ issue.rule }}
                    </span>
                    {% endif %}
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        {{ issue.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </span>
                </div>
            </div>
        </div>
        <!-- Actions -->
        <div class="flex flex-wrap gap-2">
            {% if issue.status in ['open', 'in_progress'] %}
            <button @click="resolveIssue()"
                    :disabled="actionLoading"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Merged
            </button>
            <button @click="ignoreIssue()"
                    :disabled="actionLoading"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg font-medium transition-colors flex items-center gap-2 disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                </svg>
                Ignore
            </button>
            {% else %}
            <button @click="reopenIssue()"
                    :disabled="actionLoading"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Reopen
            </button>
            {% endif %}
            <button @click="startFix()"
                    class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg font-medium transition-colors flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Start Fix
            </button>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- LEFT COLUMN (2/3) -->
        <div class="lg:col-span-2 space-y-6">

            <!-- DESCRIPTION -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Descrizione
                </h3>
                <div class="prose prose-sm dark:prose-invert max-w-none">
                    {{ issue.description | safe }}
                </div>
            </div>

            <!-- LOCATION -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Posizione nel codice
                </h3>
                <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="font-mono text-sm text-gray-700 dark:text-gray-300">{{ issue.file }}</span>
                    {% if issue.line %}
                    <span class="text-gray-400">:</span>
                    <span class="font-mono text-sm text-primary">Line {{ issue.line }}{% if issue.end_line and issue.end_line != issue.line %}-{{ issue.end_line }}{% endif %}</span>
                    {% endif %}
                </div>
            </div>

            <!-- CURRENT CODE -->
            {% if issue.current_code %}
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Codice Problematico
                    </h3>
                    <button @click="copyToClipboard($refs.currentCode.innerText)" class="text-sm text-gray-400 hover:text-gray-600 dark:hover:text-white transition-colors">Copia</button>
                </div>
                <pre class="p-4 overflow-x-auto code-block text-sm bg-gray-50 dark:bg-gray-900" x-ref="currentCode"><code class="text-gray-800 dark:text-gray-300">{{ issue.current_code }}</code></pre>
            </div>
            {% endif %}

            <!-- SUGGESTED FIX -->
            {% if issue.suggested_fix %}
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Fix Suggerito
                    </h3>
                    <button @click="copyToClipboard($refs.suggestedFix.innerText)" class="text-sm text-gray-400 hover:text-gray-600 dark:hover:text-white transition-colors">Copia</button>
                </div>
                <pre class="p-4 overflow-x-auto code-block text-sm bg-gray-50 dark:bg-gray-900" x-ref="suggestedFix"><code class="text-gray-800 dark:text-gray-300">{{ issue.suggested_fix }}</code></pre>
            </div>
            {% endif %}

            <!-- FIX RESULT (shown when fixed) -->
            {% if issue.fix_code %}
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-green-300 dark:border-green-500/30 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-green-50 dark:bg-green-500/10">
                    <h3 class="text-lg font-semibold flex items-center gap-2 text-green-700 dark:text-green-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Fix Applicato
                        {% if issue.fixed_by and issue.fixed_at %}
                        <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2">da {{ issue.fixed_by }} il {{ issue.fixed_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <!-- Fix explanation -->
                    {% if issue.fix_explanation %}
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Spiegazione</h4>
                        <p class="text-gray-700 dark:text-gray-300 text-sm">{{ issue.fix_explanation }}</p>
                    </div>
                    {% endif %}

                    <!-- Fix code -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Codice</h4>
                        <pre class="p-4 overflow-x-auto code-block text-sm bg-gray-50 dark:bg-gray-900 rounded-lg"><code class="text-gray-800 dark:text-gray-300">{{ issue.fix_code }}</code></pre>
                    </div>

                    <!-- Files modified -->
                    {% if issue.fix_files_modified %}
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">File Modificati</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for file in issue.fix_files_modified %}
                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-sm font-mono">{{ file }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Git info -->
                    <div class="flex flex-wrap items-center gap-6 text-sm">
                        {% if issue.fix_branch %}
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="text-gray-500 dark:text-gray-400">Branch:</span>
                            <span class="font-mono text-primary">{{ issue.fix_branch }}</span>
                        </div>
                        {% endif %}
                        {% if issue.fix_commit_sha %}
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                            </svg>
                            <span class="text-gray-500 dark:text-gray-400">Commit:</span>
                            <span class="font-mono text-gray-700 dark:text-gray-300">{{ issue.fix_commit_sha[:8] }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- RIGHT COLUMN (1/3) -->
        <div class="space-y-6">

            <!-- EFFORT ESTIMATION -->
            {% if issue.estimated_effort %}
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Stima Effort
                </h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Complessita</span>
                            <span class="font-bold text-lg">{{ issue.estimated_effort }}/5</span>
                        </div>
                        <div class="flex gap-1">
                            {% for i in range(5) %}
                            <div class="h-2 flex-1 rounded-full {% if i < issue.estimated_effort %}bg-yellow-500{% else %}bg-gray-200 dark:bg-gray-700{% endif %}"></div>
                            {% endfor %}
                        </div>
                    </div>
                    {% if issue.estimated_files_count %}
                    <div class="flex items-center justify-between py-2 border-t border-gray-200 dark:border-gray-700">
                        <span class="text-sm text-gray-500 dark:text-gray-400">File da modificare</span>
                        <span class="font-medium">{{ issue.estimated_files_count }} file{% if issue.estimated_files_count > 1 %}s{% endif %}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- REFERENCES -->
            {% if issue.references %}
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                    </svg>
                    Riferimenti
                </h3>
                <div class="space-y-2">
                    {% for ref in issue.references %}
                    <a href="{{ ref }}" target="_blank" class="block p-3 bg-gray-50 dark:bg-gray-900 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <div class="text-sm font-medium text-primary truncate">{{ ref }}</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- FLAGGED BY -->
            {% if issue.flagged_by %}
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
                    </svg>
                    Segnalato da
                </h3>
                <div class="flex flex-wrap gap-2">
                    {% for agent in issue.flagged_by %}
                    <span class="px-3 py-1 bg-purple-100 dark:bg-purple-500/20 text-purple-700 dark:text-purple-400 rounded-full text-sm">{{ agent }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- RELATED INFO -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Info
                </h3>
                <div class="space-y-3 text-sm">
                    {% if repository %}
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Repository</span>
                        <a href="/repos" class="text-primary hover:underline">{{ repository.name }}</a>
                    </div>
                    {% endif %}
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Issue ID</span>
                        <span class="font-mono text-xs text-gray-600 dark:text-gray-300">{{ issue.id[:8] }}...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Ultimo update</span>
                        <span class="text-gray-600 dark:text-gray-300">{{ issue.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                </div>
            </div>

            <!-- FIX LOG BUTTON -->
            {% if issue.fix_session_id %}
            <button @click="showFixLog = true" class="w-full px-4 py-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center justify-center gap-2">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Visualizza Fix Log (S3)
            </button>
            {% endif %}

        </div>
    </div>

    <!-- FIX LOG MODAL -->
    <div x-show="showFixLog"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
         @click.self="showFixLog = false"
         style="display: none;">
        <div x-show="showFixLog"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">

            <!-- Header -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between shrink-0">
                <h3 class="text-lg font-semibold">Fix Log - Session {{ issue.fix_session_id[:8] if issue.fix_session_id else '' }}...</h3>
                <button @click="showFixLog = false" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <template x-if="fixLogLoading">
                    <div class="flex items-center justify-center py-12">
                        <svg class="animate-spin w-8 h-8 text-primary" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                        </svg>
                    </div>
                </template>
                <template x-if="!fixLogLoading && fixLog">
                    <div class="space-y-6">
                        <!-- Summary -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                                <div class="text-sm text-gray-500">Status</div>
                                <div class="font-medium" x-text="fixLog.status"></div>
                            </div>
                            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                                <div class="text-sm text-gray-500">Issues Requested</div>
                                <div class="font-medium" x-text="fixLog.issues_requested"></div>
                            </div>
                            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                                <div class="text-sm text-gray-500">Issues Fixed</div>
                                <div class="font-medium" x-text="fixLog.issues_fixed"></div>
                            </div>
                            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                                <div class="text-sm text-gray-500">Branch</div>
                                <div class="font-medium font-mono text-sm" x-text="fixLog.branch_name || '-'"></div>
                            </div>
                        </div>

                        <!-- Claude Prompts -->
                        <template x-if="fixLog.claude_prompts && fixLog.claude_prompts.length > 0">
                            <div>
                                <h4 class="font-semibold mb-3">Claude Prompts</h4>
                                <template x-for="(prompt, idx) in fixLog.claude_prompts" :key="idx">
                                    <div class="mb-4 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="px-2 py-1 bg-purple-100 dark:bg-purple-500/20 text-purple-700 dark:text-purple-400 rounded text-xs" x-text="prompt.type"></span>
                                            <span class="text-sm text-gray-500" x-text="'Batch ' + prompt.batch"></span>
                                        </div>
                                        <pre class="text-xs overflow-x-auto whitespace-pre-wrap" x-text="prompt.prompt"></pre>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Gemini Review -->
                        <template x-if="fixLog.gemini_review">
                            <div>
                                <h4 class="font-semibold mb-3">Gemini Review</h4>
                                <pre class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg text-sm overflow-x-auto whitespace-pre-wrap" x-text="fixLog.gemini_review"></pre>
                            </div>
                        </template>
                    </div>
                </template>
                <template x-if="!fixLogLoading && fixLogError">
                    <div class="text-center py-12 text-red-500">
                        <p x-text="fixLogError"></p>
                    </div>
                </template>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function issueDetailApp() {
    return {
        issueId: '{{ issue.id }}',
        actionLoading: false,
        showFixLog: false,
        fixLog: null,
        fixLogLoading: false,
        fixLogError: null,

        init() {
            // Watch for fix log modal open
            this.$watch('showFixLog', async (value) => {
                if (value && !this.fixLog) {
                    await this.loadFixLog();
                }
            });
        },

        async resolveIssue() {
            if (!confirm('Sei sicuro di voler segnare questa issue come MERGED?')) return;
            await this.updateStatus('resolve');
        },

        async ignoreIssue() {
            const note = prompt('Motivo per ignorare (opzionale):');
            if (note === null) return; // User cancelled
            await this.updateStatus('ignore', note);
        },

        async reopenIssue() {
            await this.updateStatus('reopen');
        },

        async updateStatus(action, note = '') {
            this.actionLoading = true;
            try {
                const url = `/api/issues/${this.issueId}/${action}${note ? '?note=' + encodeURIComponent(note) : ''}`;
                console.log('[Issue] Calling:', url);
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();
                console.log('[Issue] Response:', res.status, data);
                if (res.ok) {
                    console.log('[Issue] Success, reloading page...');
                    window.location.reload();
                } else {
                    alert('Errore: ' + (data.detail || 'Unknown error'));
                }
            } catch (e) {
                console.error('[Issue] Error:', e);
                alert('Errore di rete: ' + e.message);
            }
            this.actionLoading = false;
        },

        startFix() {
            // Redirect to issues page with this issue pre-selected for fix
            window.location.href = `/issues?fix=${this.issueId}`;
        },

        async loadFixLog() {
            this.fixLogLoading = true;
            this.fixLogError = null;
            try {
                const res = await fetch(`/api/issues/${this.issueId}/fix-log`);
                if (res.ok) {
                    this.fixLog = await res.json();
                } else {
                    const error = await res.json();
                    this.fixLogError = error.detail || 'Failed to load fix log';
                }
            } catch (e) {
                this.fixLogError = 'Network error: ' + e.message;
            }
            this.fixLogLoading = false;
        },

        copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show toast
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { message: 'Copiato negli appunti!', type: 'success' }
                }));
            });
        }
    }
}
</script>
{% endblock %}
