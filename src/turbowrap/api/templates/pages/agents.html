{% extends "base.html" %}

{% block title %}Agenti AI - TurboWrap{% endblock %}

{% block head %}
<!-- Mermaid.js for diagrams -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<!-- Marked.js for markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* Agent card hover effects */
.agent-card {
    transition: all 0.2s ease;
}
.agent-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.dark .agent-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Mermaid container */
.mermaid-container {
    @apply bg-gray-100 dark:bg-gray-900 rounded-xl p-6 overflow-x-auto my-4;
}
.mermaid svg {
    max-width: 100%;
    height: auto;
}

/* Markdown preview prose styles */
.preview-content h1 { @apply text-2xl font-bold mt-6 mb-4 text-gray-900 dark:text-white; }
.preview-content h2 { @apply text-xl font-bold mt-5 mb-3 text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-2; }
.preview-content h3 { @apply text-lg font-semibold mt-4 mb-2 text-gray-800 dark:text-gray-200; }
.preview-content h4 { @apply text-base font-semibold mt-3 mb-2 text-gray-800 dark:text-gray-200; }
.preview-content p { @apply my-3 leading-relaxed text-gray-700 dark:text-gray-300; }
.preview-content ul { @apply my-3 pl-6 list-disc space-y-1; }
.preview-content ol { @apply my-3 pl-6 list-decimal space-y-1; }
.preview-content li { @apply text-gray-700 dark:text-gray-300; }
.preview-content code:not(pre code) { @apply bg-gray-200 dark:bg-gray-700 text-pink-600 dark:text-pink-400 px-1.5 py-0.5 rounded text-sm font-mono; }
.preview-content pre { @apply bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto my-4 text-sm font-mono; }
.preview-content pre code { @apply bg-transparent text-gray-100 p-0; }
.preview-content blockquote { @apply border-l-4 border-gray-300 dark:border-gray-600 pl-4 my-4 italic text-gray-600 dark:text-gray-400; }
.preview-content a { @apply text-indigo-600 dark:text-indigo-400 hover:underline; }
.preview-content hr { @apply my-6 border-gray-200 dark:border-gray-700; }
.preview-content table { @apply w-full my-4 border-collapse; }
.preview-content th { @apply bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 px-4 py-2 text-left font-semibold; }
.preview-content td { @apply border border-gray-300 dark:border-gray-600 px-4 py-2; }
.preview-content strong { @apply font-semibold text-gray-900 dark:text-white; }
.preview-content em { @apply italic; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8" x-data="agentsApp()">

    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Agenti AI</h1>
                <p class="text-sm text-gray-500" x-text="totalAgents + ' agenti disponibili'"></p>
            </div>
        </div>

        <!-- Search -->
        <div class="relative">
            <input type="text"
                   x-model="searchQuery"
                   placeholder="Cerca agente..."
                   class="w-64 pl-10 pr-4 py-2 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <svg class="w-5 h-5 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex items-center justify-center py-12">
        <svg class="w-8 h-8 animate-spin text-indigo-600" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <span class="ml-3 text-gray-500">Caricamento agenti...</span>
    </div>

    <!-- Categories Accordion -->
    <div x-show="!loading" class="space-y-4">
        <template x-for="category in filteredCategories" :key="category.name">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">

                <!-- Category Header -->
                <button @click="category.open = !category.open"
                        class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl" x-text="category.icon"></span>
                        <span class="font-semibold text-lg text-gray-900 dark:text-white" x-text="category.name"></span>
                        <span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded-full text-sm text-gray-600 dark:text-gray-400"
                              x-text="category.agents.length + ' agenti'"></span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 transition-transform duration-200"
                         :class="{ 'rotate-180': category.open }"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>

                <!-- Agents Grid -->
                <div x-show="category.open" x-collapse>
                    <div class="px-6 pb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        <template x-for="agent in category.agents" :key="agent.name">
                            <div class="agent-card bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 border border-gray-100 dark:border-gray-600 hover:border-indigo-300 dark:hover:border-indigo-500">

                                <!-- Agent Header -->
                                <div class="flex items-start gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-sm"
                                         :class="getColorClass(agent.color)">
                                        <span x-text="agent.name.substring(0, 2).toUpperCase()"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-medium text-gray-900 dark:text-white truncate" x-text="agent.name"></h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="px-1.5 py-0.5 text-xs rounded bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300"
                                                  x-text="agent.model || 'opus'"></span>
                                            <span class="text-xs text-gray-400" x-text="(agent.tokens || 0) + ' tokens'"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Description -->
                                <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-4" x-text="agent.description"></p>

                                <!-- Actions -->
                                <div class="flex items-center gap-2">
                                    <button @click="openEditor(agent)"
                                            class="flex-1 px-3 py-1.5 text-sm bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors flex items-center justify-center gap-1.5">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                        <span>Modifica</span>
                                    </button>
                                    <button @click="openAIChat(agent)"
                                            class="flex-1 px-3 py-1.5 text-sm bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg hover:from-indigo-600 hover:to-purple-600 transition-colors flex items-center justify-center gap-1.5">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                        <span>AI Edit</span>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Sezione Contesto -->
    <div x-show="!loading && contextDocs.length > 0" class="mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="px-6 py-4 border-b dark:border-gray-700 flex items-center gap-3">
            <span class="text-2xl">ðŸ“š</span>
            <div>
                <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Contesto</h2>
                <p class="text-sm text-gray-500">Documenti di riferimento e guide (non eseguibili)</p>
            </div>
        </div>
        <div class="p-6 space-y-3">
            <template x-for="doc in contextDocs" :key="doc.name">
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-600 hover:border-gray-200 dark:hover:border-gray-500 transition-colors">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl" x-text="doc.icon || 'ðŸ“„'"></span>
                        <div>
                            <h3 class="font-medium text-gray-900 dark:text-white" x-text="doc.name"></h3>
                            <p class="text-sm text-gray-500" x-text="doc.description"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400" x-text="(doc.tokens || 0) + ' tokens'"></span>
                        <button @click="openEditor(doc)"
                                class="px-4 py-2 text-sm bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            <span>Visualizza</span>
                        </button>
                        <button @click="openEditor(doc)"
                                class="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            <span>Modifica</span>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Sezione Docs -->
    <div x-show="!loading" class="mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="px-6 py-4 border-b dark:border-gray-700 flex items-center gap-3">
            <span class="text-2xl">ðŸ“–</span>
            <div>
                <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Documentazione</h2>
                <p class="text-sm text-gray-500">Documenti del progetto (dalla cartella docs/)</p>
            </div>
            <div class="ml-auto">
                <span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded-full text-sm text-gray-600 dark:text-gray-400"
                      x-text="projectDocs.length + ' documenti'"></span>
            </div>
        </div>
        <div class="p-6">
            <!-- Loading state -->
            <div x-show="loadingDocs" class="flex items-center justify-center py-8">
                <svg class="w-6 h-6 animate-spin text-indigo-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <span class="ml-3 text-gray-500">Caricamento docs...</span>
            </div>

            <!-- Docs grid -->
            <div x-show="!loadingDocs" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="doc in projectDocs" :key="doc.name">
                    <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-600 hover:border-indigo-300 dark:hover:border-indigo-500 transition-colors">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white shrink-0">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-medium text-gray-900 dark:text-white truncate" x-text="doc.name"></h3>
                                <p class="text-xs text-gray-500 mt-1" x-text="doc.path"></p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mt-2" x-text="doc.preview || 'Documento markdown'"></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-4">
                            <button @click="openDocEditor(doc)"
                                    class="flex-1 px-3 py-1.5 text-sm bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors flex items-center justify-center gap-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                <span>Visualizza</span>
                            </button>
                            <button @click="openAIChatDoc(doc)"
                                    class="flex-1 px-3 py-1.5 text-sm bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg hover:from-indigo-600 hover:to-purple-600 transition-colors flex items-center justify-center gap-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <span>AI Edit</span>
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Empty state -->
            <div x-show="!loadingDocs && projectDocs.length === 0" class="text-center py-8 text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p>Nessun documento trovato nella cartella docs/</p>
            </div>
        </div>
    </div>

    <!-- Editor Modal (Fullscreen) -->
    <div x-show="showEditor" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         @click.self="showEditor = false"
         @keydown.escape.window="showEditor = false">
        <div class="bg-white dark:bg-gray-800 shadow-2xl w-full h-full flex flex-col">

            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center text-white font-bold text-sm"
                         x-text="selectedAgent?.name?.substring(0, 2).toUpperCase()"></div>
                    <div>
                        <h2 class="font-semibold text-lg" x-text="selectedAgent?.name"></h2>
                        <p class="text-sm text-gray-500" x-text="selectedAgent?.path ? selectedAgent.path.split('/').slice(-2).join('/') : 'agents/' + selectedAgent?.name + '.md'"></p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="editorMode = 'edit'"
                            :class="editorMode === 'edit' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'"
                            class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
                        Edit
                    </button>
                    <button @click="setPreviewMode()"
                            :class="editorMode === 'preview' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'"
                            class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
                        Preview
                    </button>
                    <button @click="setDiagramMode()"
                            :class="editorMode === 'diagram' ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'"
                            class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                        </svg>
                        Diagram
                    </button>
                    <button @click="showEditor = false" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-hidden">
                <!-- Edit Mode -->
                <div x-show="editorMode === 'edit'" class="h-full">
                    <textarea x-model="editorContent"
                              class="w-full h-full p-6 font-mono text-sm bg-gray-900 text-gray-100 resize-none focus:outline-none leading-relaxed"
                              placeholder="# Agent Instructions..."></textarea>
                </div>

                <!-- Preview Mode (Markdown Rendered) -->
                <div x-show="editorMode === 'preview'" class="h-full overflow-auto p-6 bg-white dark:bg-gray-800">
                    <div class="preview-content max-w-4xl mx-auto" x-html="renderedMarkdown"></div>
                </div>

                <!-- Diagram Mode -->
                <div x-show="editorMode === 'diagram'" class="h-full overflow-auto p-6 bg-gray-50 dark:bg-gray-900">
                    <div class="max-w-5xl mx-auto">
                        <!-- Diagram Header with Generate Button -->
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Diagramma Mermaid</h3>
                                <p class="text-sm text-gray-500">Visualizza o genera un diagramma di flusso</p>
                            </div>
                            <button @click="generateDiagram()"
                                    :disabled="generatingDiagram"
                                    class="px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-lg hover:from-purple-600 hover:to-indigo-600 transition-all flex items-center gap-2 disabled:opacity-50 shadow-lg">
                                <svg x-show="!generatingDiagram" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <svg x-show="generatingDiagram" class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                </svg>
                                <span x-text="generatingDiagram ? 'Generazione...' : 'Genera con AI'"></span>
                            </button>
                        </div>

                        <!-- Existing Mermaid from Content -->
                        <template x-if="existingMermaid">
                            <div class="mermaid-container bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                                <div class="text-xs text-gray-500 mb-3 font-medium">Diagramma esistente nel documento:</div>
                                <div class="mermaid" id="existing-mermaid-diagram"></div>
                            </div>
                        </template>

                        <!-- AI Generated Diagram -->
                        <template x-if="generatedMermaid">
                            <div class="mermaid-container bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 border border-purple-200 dark:border-purple-800 mt-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="text-xs text-purple-600 dark:text-purple-400 font-medium flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                        Generato con AI
                                    </div>
                                    <button @click="copyMermaidCode()" class="text-xs text-purple-600 hover:text-purple-700 flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                        </svg>
                                        Copia codice
                                    </button>
                                </div>
                                <div class="mermaid" id="generated-mermaid-diagram"></div>
                            </div>
                        </template>

                        <!-- No Diagram State -->
                        <div x-show="!existingMermaid && !generatedMermaid && !generatingDiagram"
                             class="text-center py-16 text-gray-500">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                            </svg>
                            <p class="font-medium text-gray-700 dark:text-gray-300 mb-2">Nessun diagramma</p>
                            <p class="text-sm">Clicca "Genera con AI" per creare un diagramma di flusso del documento</p>
                        </div>

                        <!-- Mermaid Code (collapsible) -->
                        <template x-if="generatedMermaidCode">
                            <details class="mt-4">
                                <summary class="cursor-pointer text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                                    Mostra codice Mermaid
                                </summary>
                                <pre class="mt-2 bg-gray-900 text-gray-100 p-4 rounded-lg text-xs overflow-x-auto font-mono" x-text="generatedMermaidCode"></pre>
                            </details>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 px-6 py-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                <button @click="showEditor = false"
                        class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-colors">
                    Annulla
                </button>
                <button @click="saveAgent()"
                        :disabled="saving"
                        class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 disabled:opacity-50">
                    <svg x-show="saving" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <svg x-show="!saving" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span x-text="saving ? 'Salvataggio...' : 'Salva'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.show" x-cloak
         x-transition:enter="transform ease-out duration-300"
         x-transition:enter-start="translate-y-2 opacity-0"
         x-transition:enter-end="translate-y-0 opacity-100"
         x-transition:leave="transform ease-in duration-200"
         x-transition:leave-start="translate-y-0 opacity-100"
         x-transition:leave-end="translate-y-2 opacity-0"
         class="fixed bottom-4 right-4 px-6 py-4 rounded-xl shadow-lg flex items-center gap-3"
         :class="toast.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'">
        <span x-text="toast.message"></span>
    </div>
</div>

<script>
// Initialize Mermaid
mermaid.initialize({
    startOnLoad: false,
    theme: document.documentElement.classList.contains('dark') ? 'dark' : 'default',
    securityLevel: 'loose',
    flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' }
});

function agentsApp() {
    return {
        loading: true,
        loadingDocs: false,
        searchQuery: '',
        showEditor: false,
        selectedAgent: null,
        editorMode: 'edit',
        editorContent: '',
        saving: false,
        toast: { show: false, message: '', type: 'success' },
        categories: [],
        contextDocs: [],
        projectDocs: [],

        // Preview & Diagram state
        renderedMarkdown: '',
        existingMermaid: null,
        generatedMermaid: false,
        generatedMermaidCode: '',
        generatingDiagram: false,

        get totalAgents() {
            return this.categories.reduce((sum, cat) => sum + cat.agents.length, 0) + this.contextDocs.length;
        },

        get filteredCategories() {
            if (!this.searchQuery) return this.categories;
            const query = this.searchQuery.toLowerCase();
            return this.categories.map(cat => ({
                ...cat,
                agents: cat.agents.filter(a =>
                    a.name.toLowerCase().includes(query) ||
                    (a.description && a.description.toLowerCase().includes(query))
                )
            })).filter(cat => cat.agents.length > 0);
        },

        async init() {
            await this.loadAgents();
            await this.loadDocs();
        },

        async loadAgents() {
            this.loading = true;
            try {
                const response = await fetch('/api/settings/agents');
                if (response.ok) {
                    const agents = await response.json();
                    this.categorizeAgents(agents);
                }
            } catch (e) {
                console.error('Failed to load agents:', e);
            }
            this.loading = false;
        },

        categorizeAgents(agents) {
            const categoryMap = {
                'Reviewer': { icon: 'ðŸ”', agents: [], open: true },
                'Fixer': { icon: 'ðŸ”§', agents: [], open: false },
                'Tester': { icon: 'ðŸ§ª', agents: [], open: false },
                'Git': { icon: 'ðŸŒ¿', agents: [], open: false },
                'Development': { icon: 'ðŸ’»', agents: [], open: false },
                'Utility': { icon: 'âš™ï¸', agents: [], open: false },
            };

            const contextNames = ['engineering_principles', 'infra_ops'];
            const contextIcons = {
                'engineering_principles': 'ðŸ“•',
                'infra_ops': 'ðŸ“™'
            };

            agents.forEach(agent => {
                const name = agent.name.replace(/-/g, '_');

                // Check if it's a context doc
                if (contextNames.includes(name)) {
                    this.contextDocs.push({
                        ...agent,
                        icon: contextIcons[name] || 'ðŸ“„'
                    });
                    return;
                }

                // Categorize by prefix
                let category = 'Utility';
                if (name.startsWith('reviewer_') || name.startsWith('analyst_') || name === 'evaluator') {
                    category = 'Reviewer';
                } else if (name.startsWith('fix') || name.startsWith('lint') || name.startsWith('re_fixer')) {
                    category = 'Fixer';
                } else if (name.startsWith('test_')) {
                    category = 'Tester';
                } else if (name.startsWith('git_')) {
                    category = 'Git';
                } else if (name === 'dev_be' || name === 'dev_fe' || name.startsWith('dev-')) {
                    category = 'Development';
                }

                if (categoryMap[category]) {
                    categoryMap[category].agents.push({
                        ...agent,
                        color: this.getAgentColor(category)
                    });
                }
            });

            // Convert to array and filter empty categories
            this.categories = Object.entries(categoryMap)
                .filter(([_, cat]) => cat.agents.length > 0)
                .map(([name, cat]) => ({ name, ...cat }));
        },

        getAgentColor(category) {
            const colors = {
                'Reviewer': 'blue',
                'Fixer': 'green',
                'Tester': 'teal',
                'Git': 'orange',
                'Development': 'red',
                'Utility': 'purple'
            };
            return colors[category] || 'gray';
        },

        getColorClass(color) {
            const colors = {
                'blue': 'bg-blue-500',
                'cyan': 'bg-cyan-500',
                'green': 'bg-emerald-500',
                'yellow': 'bg-yellow-500',
                'orange': 'bg-orange-500',
                'red': 'bg-red-500',
                'pink': 'bg-pink-500',
                'purple': 'bg-purple-500',
                'indigo': 'bg-indigo-500',
                'teal': 'bg-teal-500',
                'gray': 'bg-gray-500',
            };
            return colors[color] || 'bg-gray-500';
        },

        async openEditor(agent) {
            this.selectedAgent = agent;
            this.editorMode = 'edit';
            this.editorContent = 'Caricamento...';
            this.showEditor = true;

            // Extract filename from path (without .md extension)
            // e.g., "/path/to/agents/analyst_func.md" -> "analyst_func"
            const fileName = agent.path ? agent.path.split('/').pop().replace('.md', '') : agent.name;

            try {
                const response = await fetch(`/api/settings/agents/${fileName}`);
                if (response.ok) {
                    const data = await response.json();
                    this.editorContent = data.raw_content || '';
                } else {
                    const error = await response.json().catch(() => ({}));
                    this.editorContent = `# Errore caricamento\n\n${error.detail || 'Errore sconosciuto'}`;
                    console.error('API error:', response.status, error);
                }
            } catch (e) {
                console.error('Failed to load agent:', e);
                this.editorContent = `# Errore caricamento\n\n${e.message}`;
            }
        },

        async saveAgent() {
            if (!this.selectedAgent) return;
            this.saving = true;

            // Extract filename from path (without .md extension)
            const fileName = this.selectedAgent.path
                ? this.selectedAgent.path.split('/').pop().replace('.md', '')
                : this.selectedAgent.name;

            try {
                const response = await fetch(`/api/settings/agents/${fileName}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: this.editorContent })
                });

                if (response.ok) {
                    this.showToast('Agente salvato con successo', 'success');
                    this.showEditor = false;
                    await this.loadAgents();
                } else {
                    this.showToast('Errore durante il salvataggio', 'error');
                }
            } catch (e) {
                console.error('Failed to save agent:', e);
                this.showToast('Errore durante il salvataggio', 'error');
            }

            this.saving = false;
        },

        openAIChat(agent) {
            // Open chat sidebar with slash command to modify the agent
            // Extract filename from path or use name
            const fileName = agent.path
                ? agent.path.split('/').pop().replace('.md', '')
                : agent.name;
            const agentPath = `agents/${fileName}.md`;

            // Dispatch event to open chat with command pre-filled
            window.dispatchEvent(new CustomEvent('open-chat-with-command', {
                detail: {
                    command: `/edit ${agentPath}`,
                    reuseSession: true
                }
            }));
        },

        // Project Docs Functions
        async loadDocs() {
            this.loadingDocs = true;
            try {
                const response = await fetch('/api/settings/docs');
                if (response.ok) {
                    this.projectDocs = await response.json();
                }
            } catch (e) {
                console.error('Failed to load docs:', e);
            }
            this.loadingDocs = false;
        },

        async openDocEditor(doc) {
            this.selectedAgent = { name: doc.name, isDoc: true, path: doc.path };
            this.editorMode = 'edit';
            this.editorContent = 'Caricamento...';
            this.showEditor = true;

            try {
                const response = await fetch(`/api/settings/docs/${encodeURIComponent(doc.path)}`);
                if (response.ok) {
                    const data = await response.json();
                    this.editorContent = data.content || '';
                }
            } catch (e) {
                console.error('Failed to load doc:', e);
                this.editorContent = '# Errore caricamento';
            }
        },

        openAIChatDoc(doc) {
            // Open chat sidebar with slash command to modify the doc
            window.dispatchEvent(new CustomEvent('open-chat-with-command', {
                detail: {
                    command: `/edit ${doc.path}`,
                    reuseSession: true
                }
            }));
        },

        showToast(message, type = 'success') {
            this.toast = { show: true, message, type };
            setTimeout(() => { this.toast.show = false; }, 3000);
        },

        // Preview & Diagram Functions
        setPreviewMode() {
            this.editorMode = 'preview';
            this.renderMarkdown();
        },

        setDiagramMode() {
            this.editorMode = 'diagram';
            this.extractExistingMermaid();
            this.$nextTick(() => {
                if (this.existingMermaid) {
                    this.renderMermaidDiagram('existing-mermaid-diagram', this.existingMermaid);
                }
                if (this.generatedMermaidCode) {
                    this.renderMermaidDiagram('generated-mermaid-diagram', this.generatedMermaidCode);
                }
            });
        },

        renderMarkdown() {
            if (!this.editorContent) {
                this.renderedMarkdown = '';
                return;
            }

            // Configure marked
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: true,
                    mangle: false
                });

                // Custom renderer for mermaid code blocks
                const renderer = new marked.Renderer();
                const originalCode = renderer.code.bind(renderer);
                renderer.code = (code, language) => {
                    if (language === 'mermaid') {
                        const id = 'md-mermaid-' + Math.random().toString(36).substr(2, 9);
                        // Render mermaid inline
                        setTimeout(() => this.renderMermaidDiagram(id, code), 100);
                        return `<div class="mermaid-container"><div class="mermaid" id="${id}"></div></div>`;
                    }
                    return originalCode(code, language);
                };

                marked.use({ renderer });
                this.renderedMarkdown = marked.parse(this.editorContent);
            } else {
                // Fallback: basic formatting
                this.renderedMarkdown = this.editorContent
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
            }
        },

        extractExistingMermaid() {
            // Extract first mermaid code block from content
            const mermaidMatch = this.editorContent.match(/```mermaid\n([\s\S]*?)```/);
            this.existingMermaid = mermaidMatch ? mermaidMatch[1].trim() : null;
        },

        async renderMermaidDiagram(elementId, code) {
            const el = document.getElementById(elementId);
            if (!el || !code) return;

            try {
                el.innerHTML = '';
                const { svg } = await mermaid.render(`svg-${elementId}`, code);
                el.innerHTML = svg;
            } catch (e) {
                console.error('Mermaid render error:', e);
                el.innerHTML = `<pre class="text-red-500 text-sm p-4 bg-red-50 dark:bg-red-900/20 rounded">${e.message || 'Errore nel rendering del diagramma'}\n\n${code}</pre>`;
            }
        },

        async generateDiagram() {
            if (this.generatingDiagram || !this.editorContent) return;

            this.generatingDiagram = true;
            this.generatedMermaid = false;
            this.generatedMermaidCode = '';

            try {
                const response = await fetch('/api/cli-chat/generate-mermaid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.editorContent,
                        type: 'flowchart',
                        context: this.selectedAgent?.name || 'document'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    this.generatedMermaidCode = data.mermaid_code;
                    this.generatedMermaid = true;

                    // Render the diagram
                    this.$nextTick(() => {
                        this.renderMermaidDiagram('generated-mermaid-diagram', this.generatedMermaidCode);
                    });

                    this.showToast('Diagramma generato con successo', 'success');
                } else {
                    const error = await response.json().catch(() => ({}));
                    this.showToast(error.detail || 'Errore nella generazione', 'error');
                }
            } catch (e) {
                console.error('Failed to generate diagram:', e);
                this.showToast('Errore nella generazione del diagramma', 'error');
            } finally {
                this.generatingDiagram = false;
            }
        },

        copyMermaidCode() {
            if (this.generatedMermaidCode) {
                navigator.clipboard.writeText('```mermaid\n' + this.generatedMermaidCode + '\n```');
                this.showToast('Codice copiato negli appunti', 'success');
            }
        }
    }
}
</script>
{% endblock %}
