{% extends "base.html" %}

{% block title %}Tasks - TurboWrap{% endblock %}

{% block content %}
<div class="space-y-6" x-data="liveTasksApp()">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold flex items-center gap-3">
                <span>Tasks</span>
                <template x-if="operations.length > 0">
                    <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400 rounded-full text-sm font-medium">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <span x-text="operations.length"></span> active
                    </span>
                </template>
            </h1>
            <p class="text-gray-500 dark:text-gray-400 mt-1">Operazioni attive e storico</p>
        </div>
        <div class="flex items-center gap-2">
            <button @click="resetStuckIssues()"
                    class="px-4 py-2 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors flex items-center gap-2"
                    title="Resetta tutte le issue bloccate in 'in_progress'">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                Reset Issues
            </button>
            <button @click="refresh()"
                    :disabled="loading"
                    class="px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors flex items-center gap-2">
                <svg class="w-5 h-5" :class="loading && 'animate-spin'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Aggiorna
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="border-b dark:border-gray-700">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button @click="activeTab = 'live'"
                    :class="activeTab === 'live' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                    <span x-show="operations.length > 0" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                Live
                <template x-if="operations.length > 0">
                    <span class="bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400 text-xs px-2 py-0.5 rounded-full" x-text="operations.length"></span>
                </template>
            </button>
            <button @click="activeTab = 'history'; loadHistory()"
                    :class="activeTab === 'history' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                History
                <template x-if="historyTotal > 0">
                    <span class="bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300 text-xs px-2 py-0.5 rounded-full" x-text="historyTotal"></span>
                </template>
            </button>
            <button @click="activeTab = 'stats'; loadStats()"
                    :class="activeTab === 'stats' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Stats
            </button>
        </nav>
    </div>

    <!-- Live Tab Content -->
    <div x-show="activeTab === 'live'" x-cloak>

    <!-- Loading state -->
    <template x-if="loading && operations.length === 0">
        <div class="flex items-center justify-center py-12">
            <svg class="w-8 h-8 animate-spin text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
        </div>
    </template>

    <!-- Empty state -->
    <template x-if="!loading && operations.length === 0">
        <div class="text-center py-16 bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Nessuna operazione attiva</h3>
            <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">
                Al momento non ci sono operazioni in corso. Fix, review, merge, push e altre operazioni appariranno qui.
            </p>
        </div>
    </template>

    <!-- Operations grouped by repository -->
    <template x-if="operations.length > 0">
        <div class="space-y-6">
            <template x-for="(repoOps, repoName) in operationsByRepo" :key="repoName">
                <div class="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 overflow-hidden">
                    <!-- Repository header -->
                    <div class="px-6 py-4 bg-gray-50 dark:bg-gray-800/50 border-b dark:border-gray-700 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                            </svg>
                            <span class="font-semibold text-lg" x-text="repoName"></span>
                        </div>
                        <span class="text-sm text-gray-500 dark:text-gray-400"
                              x-text="repoOps.length + ' operation' + (repoOps.length !== 1 ? 's' : '')"></span>
                    </div>

                    <!-- Operations list -->
                    <div class="divide-y dark:divide-gray-700">
                        <template x-for="op in repoOps" :key="op.operation_id">
                            <div class="p-6 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                <div class="flex items-start justify-between gap-4">
                                    <!-- Left: Operation info -->
                                    <div class="flex-1 space-y-3">
                                        <!-- Operation type + User + Branch -->
                                        <div class="flex items-center gap-3">
                                            <!-- Status indicator with type-specific icon -->
                                            <div class="relative" x-html="getOperationIcon(op.type)"></div>
                                            <!-- Operation badge -->
                                            <span class="px-2 py-0.5 rounded-full text-xs font-medium"
                                                  :class="getOperationBadgeClass(op.type)"
                                                  x-text="getOperationLabel(op.type)"></span>
                                            <!-- User -->
                                            <span class="font-medium" x-text="op.user_name || 'System'"></span>
                                            <!-- Branch if available -->
                                            <template x-if="op.branch_name">
                                                <span class="flex items-center gap-1">
                                                    <span class="text-gray-400">on</span>
                                                    <code class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-sm font-mono"
                                                          x-text="op.branch_name"></code>
                                                </span>
                                            </template>
                                        </div>

                                        <!-- Details chips (for fix: issue codes, for review: mode, etc.) -->
                                        <template x-if="op.details && Object.keys(op.details).length > 0">
                                            <div class="flex flex-wrap gap-2">
                                                <!-- Fix: issue codes -->
                                                <template x-if="op.type === 'fix' && op.details.issue_codes">
                                                    <template x-for="code in op.details.issue_codes" :key="code">
                                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400"
                                                              x-text="code"></span>
                                                    </template>
                                                </template>
                                                <!-- Review: mode -->
                                                <template x-if="op.type === 'review' && op.details.mode">
                                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"
                                                          x-text="op.details.mode + ' review'"></span>
                                                </template>
                                                <!-- Merge: source branch -->
                                                <template x-if="op.type === 'git_merge' && op.details.source_branch">
                                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"
                                                          x-text="'from ' + op.details.source_branch"></span>
                                                </template>
                                            </div>
                                        </template>

                                        <!-- Timing -->
                                        <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-4">
                                            <span>Started <span x-text="formatTime(op.started_at)"></span></span>
                                            <template x-if="op.is_stale">
                                                <span class="flex items-center gap-1 text-orange-500">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                    </svg>
                                                    Potrebbe essere bloccata
                                                </span>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Right: Count/Status + Actions -->
                                    <div class="flex items-center gap-3">
                                        <template x-if="op.type === 'fix' && op.details?.issue_count">
                                            <span class="text-sm font-medium px-3 py-1 bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400 rounded-full"
                                                  x-text="op.details.issue_count + ' issue' + (op.details.issue_count !== 1 ? 's' : '')"></span>
                                        </template>
                                        <!-- Action buttons -->
                                        <div class="flex items-center gap-2">
                                            <button @click="markComplete(op.operation_id)"
                                                    class="px-3 py-1.5 text-sm bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors flex items-center gap-1"
                                                    title="Marca come completata">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                Done
                                            </button>
                                            <button @click="cancelOperation(op.operation_id)"
                                                    class="px-3 py-1.5 text-sm bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors flex items-center gap-1"
                                                    title="Cancella operazione">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </template>
    </div> <!-- End Live Tab -->

    <!-- History Tab Content -->
    <div x-show="activeTab === 'history'" x-cloak>
        <!-- Filters -->
        <div class="flex flex-wrap items-center gap-4 mb-6">
            <select x-model="historyStatusFilter" @change="loadHistory(1)" class="px-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                <option value="">Tutti gli stati</option>
                <option value="completed">Completate</option>
                <option value="failed">Fallite</option>
                <option value="cancelled">Cancellate</option>
            </select>
            <select x-model="historyTypeFilter" @change="loadHistory(1)" class="px-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                <option value="">Tutti i tipi</option>
                <template x-for="type in Object.keys(operationLabels)" :key="type">
                    <option :value="type" x-text="operationLabels[type]"></option>
                </template>
                <option value="cli_task">CLI Task</option>
            </select>
        </div>

        <!-- Loading -->
        <template x-if="historyLoading">
            <div class="flex items-center justify-center py-12">
                <svg class="w-8 h-8 animate-spin text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            </div>
        </template>

        <!-- Empty state -->
        <template x-if="!historyLoading && historyOperations.length === 0">
            <div class="text-center py-16 bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700">
                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Nessuna operazione nello storico</h3>
                <p class="text-gray-500 dark:text-gray-400">Le operazioni completate, fallite o cancellate appariranno qui.</p>
            </div>
        </template>

        <!-- History Table -->
        <template x-if="!historyLoading && historyOperations.length > 0">
            <div class="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-800/50 border-b dark:border-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Stato</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Repository</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Utente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Inizio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Durata</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Dettagli</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y dark:divide-gray-700">
                        <template x-for="op in historyOperations" :key="op.operation_id">
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer" @click="showOperationDetail(op)">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium" :class="getOperationBadgeClass(op.type)" x-text="getOperationLabel(op.type)"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium" :class="getStatusBadgeClass(op.status)" x-text="op.status"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300" x-text="op.repository_name || '-'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300" x-text="op.user_name || 'System'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="formatDateTime(op.started_at)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="formatDuration(op.duration_seconds)"></td>
                                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 max-w-xs truncate">
                                    <template x-if="op.error">
                                        <span class="text-red-500" x-text="op.error.substring(0, 50) + (op.error.length > 50 ? '...' : '')" :title="op.error"></span>
                                    </template>
                                    <template x-if="!op.error && op.details?.prompt_preview">
                                        <span x-text="op.details.prompt_preview"></span>
                                    </template>
                                    <template x-if="!op.error && op.details?.s3_prompt_url">
                                        <a :href="op.details.s3_prompt_url" target="_blank" class="text-primary hover:underline ml-2">S3</a>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 flex items-center justify-between">
                    <span class="text-sm text-gray-500 dark:text-gray-400">
                        Pagina <span x-text="historyPage"></span> di <span x-text="Math.ceil(historyTotal / historyPageSize)"></span>
                        (<span x-text="historyTotal"></span> totali)
                    </span>
                    <div class="flex items-center gap-2">
                        <button @click="loadHistory(historyPage - 1)" :disabled="historyPage <= 1"
                                class="px-3 py-1 rounded border dark:border-gray-600 text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 dark:hover:bg-gray-700">
                            Prev
                        </button>
                        <button @click="loadHistory(historyPage + 1)" :disabled="!historyHasMore"
                                class="px-3 py-1 rounded border dark:border-gray-600 text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 dark:hover:bg-gray-700">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div> <!-- End History Tab -->

    <!-- Stats Tab Content -->
    <div x-show="activeTab === 'stats'" x-cloak>
        <!-- Period selector -->
        <div class="mb-6">
            <select x-model="statsDays" @change="loadStats()" class="px-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                <option value="7">Ultimi 7 giorni</option>
                <option value="14">Ultimi 14 giorni</option>
                <option value="30">Ultimi 30 giorni</option>
                <option value="90">Ultimi 90 giorni</option>
            </select>
        </div>

        <!-- Loading -->
        <template x-if="statsLoading">
            <div class="flex items-center justify-center py-12">
                <svg class="w-8 h-8 animate-spin text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            </div>
        </template>

        <!-- Stats Cards -->
        <template x-if="!statsLoading && stats">
            <div class="space-y-6">
                <!-- Total Operations -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 p-6">
                        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Totale Operazioni</div>
                        <div class="text-3xl font-bold text-gray-900 dark:text-white" x-text="stats.total_operations"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 p-6">
                        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Completate</div>
                        <div class="text-3xl font-bold text-green-600" x-text="stats.by_status?.completed || 0"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 p-6">
                        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Fallite</div>
                        <div class="text-3xl font-bold text-red-600" x-text="stats.by_status?.failed || 0"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 p-6">
                        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Cancellate</div>
                        <div class="text-3xl font-bold text-orange-600" x-text="stats.by_status?.cancelled || 0"></div>
                    </div>
                </div>

                <!-- By Type -->
                <div class="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 p-6">
                    <h3 class="text-lg font-semibold mb-4">Per Tipo</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <template x-for="(count, type) in stats.by_type || {}" :key="type">
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                <span class="px-2 py-1 rounded-full text-xs font-medium" :class="getOperationBadgeClass(type)" x-text="getOperationLabel(type)"></span>
                                <span class="font-semibold text-gray-700 dark:text-gray-300" x-text="count"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Average Duration -->
                <div class="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 p-6">
                    <h3 class="text-lg font-semibold mb-4">Durata Media (completate)</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <template x-for="(seconds, type) in stats.avg_duration_seconds || {}" :key="type">
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                <span class="text-sm text-gray-600 dark:text-gray-400" x-text="getOperationLabel(type)"></span>
                                <span class="font-semibold text-gray-700 dark:text-gray-300" x-text="formatDuration(seconds)"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div> <!-- End Stats Tab -->

    <!-- Operation Detail Modal -->
    <div x-show="selectedOperation" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="selectedOperation = null">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/50 transition-opacity" @click="selectedOperation = null"></div>

        <!-- Modal -->
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden"
                 @click.stop>
                <!-- Header -->
                <div class="flex items-center justify-between px-6 py-4 border-b dark:border-gray-700">
                    <div class="flex items-center gap-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium"
                              :class="getOperationBadgeClass(selectedOperation?.type)"
                              x-text="getOperationLabel(selectedOperation?.type)"></span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium"
                              :class="getStatusBadgeClass(selectedOperation?.status)"
                              x-text="selectedOperation?.status"></span>
                    </div>
                    <button @click="selectedOperation = null"
                            class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Body -->
                <div class="px-6 py-4 overflow-y-auto max-h-[calc(90vh-120px)] space-y-6">
                    <!-- Basic Info -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">ID Operazione</label>
                            <code class="text-sm font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded" x-text="selectedOperation?.operation_id"></code>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Repository</label>
                            <span class="text-sm" x-text="selectedOperation?.repository_name || '-'"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Utente</label>
                            <span class="text-sm" x-text="selectedOperation?.user_name || 'System'"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Branch</label>
                            <span class="text-sm font-mono" x-text="selectedOperation?.branch_name || '-'"></span>
                        </div>
                    </div>

                    <!-- Timing -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Inizio</label>
                            <span class="text-sm" x-text="formatDateTime(selectedOperation?.started_at)"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Fine</label>
                            <span class="text-sm" x-text="formatDateTime(selectedOperation?.completed_at)"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Durata</label>
                            <span class="text-sm font-semibold" x-text="formatDuration(selectedOperation?.duration_seconds)"></span>
                        </div>
                    </div>

                    <!-- Details -->
                    <template x-if="selectedOperation?.details && Object.keys(selectedOperation.details).length > 0">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Dettagli</label>
                            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 space-y-3">
                                <!-- Model -->
                                <template x-if="selectedOperation?.details?.model">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 w-24">Model:</span>
                                        <span class="text-sm font-mono" x-text="selectedOperation.details.model"></span>
                                    </div>
                                </template>
                                <!-- CLI -->
                                <template x-if="selectedOperation?.details?.cli">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 w-24">CLI:</span>
                                        <span class="text-sm font-mono" x-text="selectedOperation.details.cli"></span>
                                    </div>
                                </template>
                                <!-- Agent -->
                                <template x-if="selectedOperation?.details?.agent">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 w-24">Agent:</span>
                                        <span class="px-2 py-0.5 bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-400 rounded text-xs font-mono" x-text="selectedOperation.details.agent"></span>
                                    </div>
                                </template>
                                <!-- Working Dir -->
                                <template x-if="selectedOperation?.details?.working_dir">
                                    <div class="flex items-start gap-2">
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 w-24 shrink-0">Working Dir:</span>
                                        <code class="text-xs font-mono bg-gray-100 dark:bg-gray-600 px-2 py-1 rounded break-all" x-text="selectedOperation.details.working_dir"></code>
                                    </div>
                                </template>
                                <!-- Prompt Length -->
                                <template x-if="selectedOperation?.details?.prompt_length">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 w-24">Prompt Size:</span>
                                        <span class="text-sm" x-text="selectedOperation.details.prompt_length.toLocaleString() + ' chars'"></span>
                                    </div>
                                </template>
                                <!-- S3 Prompt URL -->
                                <template x-if="selectedOperation?.details?.s3_prompt_url">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 w-24">Prompt:</span>
                                        <a :href="selectedOperation.details.s3_prompt_url" target="_blank"
                                           class="text-sm text-primary hover:underline flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                            </svg>
                                            Visualizza su S3
                                        </a>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Prompt Preview -->
                    <template x-if="selectedOperation?.details?.prompt_preview">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Prompt Preview</label>
                            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                                <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" x-text="selectedOperation.details.prompt_preview"></p>
                            </div>
                        </div>
                    </template>

                    <!-- Error -->
                    <template x-if="selectedOperation?.error">
                        <div>
                            <label class="block text-xs font-medium text-red-500 mb-2">Errore</label>
                            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                                <p class="text-sm text-red-700 dark:text-red-400 whitespace-pre-wrap" x-text="selectedOperation.error"></p>
                            </div>
                        </div>
                    </template>

                    <!-- Result -->
                    <template x-if="selectedOperation?.result && Object.keys(selectedOperation.result).length > 0">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Risultato</label>
                            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                                <pre class="text-xs font-mono text-gray-700 dark:text-gray-300 overflow-x-auto" x-text="JSON.stringify(selectedOperation.result, null, 2)"></pre>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function liveTasksApp() {
    return {
        // Tab state
        activeTab: 'live',

        // Live operations
        operations: [],
        loading: true,
        pollInterval: null,

        // History
        historyOperations: [],
        historyLoading: false,
        historyPage: 1,
        historyPageSize: 50,
        historyTotal: 0,
        historyHasMore: false,
        historyStatusFilter: '',
        historyTypeFilter: '',

        // Stats
        stats: null,
        statsLoading: false,
        statsDays: 7,

        // Modal
        selectedOperation: null,

        // Operation labels
        operationLabels: {
            'fix': 'Fix',
            'review': 'Review',
            'git_merge': 'Merge',
            'git_push': 'Push',
            'git_pull': 'Pull',
            'clone': 'Clone',
            'sync': 'Sync',
            'promote': 'Promote',
            'deploy': 'Deploy',
            'cli_task': 'CLI Task',
        },

        get operationsByRepo() {
            const grouped = {};
            for (const op of this.operations) {
                const repoName = op.repository_name || 'System';
                if (!grouped[repoName]) {
                    grouped[repoName] = [];
                }
                grouped[repoName].push(op);
            }
            return grouped;
        },

        getOperationLabel(type) {
            return this.operationLabels[type] || type;
        },

        getOperationBadgeClass(type) {
            const classes = {
                'fix': 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400',
                'review': 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
                'git_merge': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400',
                'git_push': 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400',
                'git_pull': 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-400',
                'clone': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
                'sync': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400',
                'promote': 'bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-400',
                'deploy': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400',
                'cli_task': 'bg-slate-100 text-slate-800 dark:bg-slate-900/30 dark:text-slate-400',
            };
            return classes[type] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
        },

        getOperationIcon(type) {
            const icons = {
                'fix': `<div class="relative">
                    <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-purple-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
                'review': `<div class="relative">
                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-blue-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
                'git_merge': `<div class="relative">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-green-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
                'git_push': `<div class="relative">
                    <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-orange-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
                'git_pull': `<div class="relative">
                    <div class="w-3 h-3 bg-cyan-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-cyan-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
                'clone': `<div class="relative">
                    <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-gray-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
                'sync': `<div class="relative">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-yellow-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
                'promote': `<div class="relative">
                    <div class="w-3 h-3 bg-pink-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-pink-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
                'deploy': `<div class="relative">
                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-red-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
                'cli_task': `<div class="relative">
                    <div class="w-3 h-3 bg-slate-500 rounded-full"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-slate-500 rounded-full animate-ping opacity-75"></div>
                </div>`,
            };
            return icons[type] || icons['fix'];
        },

        async refresh() {
            this.loading = true;
            try {
                const response = await fetch('/api/operations/active');
                if (response.ok) {
                    const data = await response.json();
                    this.operations = data.operations || [];
                }
            } catch (error) {
                console.error('Error fetching operations:', error);
            } finally {
                this.loading = false;
            }
        },

        formatTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'adesso';
            if (diffMins < 60) return diffMins + 'm fa';
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return diffHours + 'h fa';
            return date.toLocaleDateString('it-IT');
        },

        async markComplete(operationId) {
            if (!confirm('Sei sicuro di voler marcare questa operazione come completata?')) {
                return;
            }
            try {
                const response = await fetch(`/api/operations/${operationId}/complete`, {
                    method: 'POST',
                });
                const data = await response.json();
                if (data.status === 'completed') {
                    // Show success toast
                    this.showToast(`Operazione completata. ${data.issues_reset} issue resettate.`, 'success');
                } else {
                    this.showToast(data.message || 'Errore', 'error');
                }
                this.refresh();
            } catch (error) {
                console.error('Error completing operation:', error);
                this.showToast('Errore nel completare operazione', 'error');
            }
        },

        async cancelOperation(operationId) {
            if (!confirm('Sei sicuro di voler cancellare questa operazione?')) {
                return;
            }
            try {
                const response = await fetch(`/api/operations/${operationId}`, {
                    method: 'DELETE',
                });
                const data = await response.json();
                if (data.status === 'cancelled') {
                    this.showToast('Operazione cancellata', 'success');
                } else {
                    this.showToast(data.message || 'Errore', 'error');
                }
                this.refresh();
            } catch (error) {
                console.error('Error cancelling operation:', error);
                this.showToast('Errore nel cancellare operazione', 'error');
            }
        },

        async resetStuckIssues() {
            if (!confirm('Sei sicuro di voler resettare tutte le issue bloccate in "in_progress"?')) {
                return;
            }
            try {
                const response = await fetch('/api/operations/issues/reset-stuck', {
                    method: 'POST',
                });
                const data = await response.json();
                if (data.status === 'success') {
                    this.showToast(`Resettate ${data.count} issue bloccate`, 'success');
                } else {
                    this.showToast(data.message || 'Errore', 'error');
                }
                this.refresh();
            } catch (error) {
                console.error('Error resetting issues:', error);
                this.showToast('Errore nel resettare le issue', 'error');
            }
        },

        showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' :
                'bg-blue-600'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        },

        // History methods
        async loadHistory(page = 1) {
            this.historyLoading = true;
            this.historyPage = page;
            try {
                const params = new URLSearchParams({
                    page: page.toString(),
                    page_size: this.historyPageSize.toString(),
                });
                if (this.historyStatusFilter) {
                    params.append('status', this.historyStatusFilter);
                }
                if (this.historyTypeFilter) {
                    params.append('type', this.historyTypeFilter);
                }
                const response = await fetch(`/api/operations/history?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    this.historyOperations = data.operations || [];
                    this.historyTotal = data.total || 0;
                    this.historyHasMore = data.has_more || false;
                }
            } catch (error) {
                console.error('Error fetching history:', error);
                this.showToast('Errore nel caricare lo storico', 'error');
            } finally {
                this.historyLoading = false;
            }
        },

        getStatusBadgeClass(status) {
            const classes = {
                'completed': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400',
                'failed': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400',
                'cancelled': 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400',
                'in_progress': 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
            };
            return classes[status] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
        },

        formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
            });
        },

        formatDuration(seconds) {
            if (seconds === null || seconds === undefined) return '-';
            if (seconds < 60) return `${Math.round(seconds)}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.round(seconds % 60)}s`;
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${mins}m`;
        },

        // Stats methods
        async loadStats() {
            this.statsLoading = true;
            try {
                const response = await fetch(`/api/operations/stats?days=${this.statsDays}`);
                if (response.ok) {
                    this.stats = await response.json();
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
                this.showToast('Errore nel caricare le statistiche', 'error');
            } finally {
                this.statsLoading = false;
            }
        },

        // Modal methods
        showOperationDetail(op) {
            this.selectedOperation = op;
        },

        init() {
            this.refresh();
            // Poll every 5 seconds
            this.pollInterval = setInterval(() => this.refresh(), 5000);
        },

        destroy() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
            }
        }
    };
}
</script>
{% endblock %}
