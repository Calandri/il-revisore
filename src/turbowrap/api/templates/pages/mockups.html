{% extends "base.html" %}

{% block title %}Mockups - TurboWrap{% endblock %}

{% block content %}
<div class="h-full flex flex-col" x-data="mockupsPage()" x-init="init()">

    <!-- Header -->
    <div class="flex items-center justify-between mb-4 shrink-0">
        <div>
            <h1 class="text-2xl font-bold flex items-center gap-2 flex-wrap">
                <span>Mockups</span>
                <template x-if="$store.globalContext?.selectedRepo">
                    <span class="text-lg font-normal text-gray-500 dark:text-gray-400">
                        per <span class="font-medium text-primary" x-text="$store.globalContext.selectedRepo.name"></span>
                    </span>
                </template>
            </h1>
            <p class="text-gray-500 dark:text-gray-400">Genera e gestisci mockup UI con AI</p>
        </div>
        <div class="flex gap-2">
            <button @click="showNewProjectModal = true"
                    class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    </svg>
                    Nuovo Progetto
                </span>
            </button>
            <button @click="openMockupChat()"
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Genera Mockup
                </span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex gap-4 min-h-0">

        <!-- ============================================ -->
        <!-- FULL-SCREEN PREVIEW MODE (when mockup selected) -->
        <!-- ============================================ -->
        <template x-if="selectedMockup">
            <div class="flex-1 flex flex-col bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                <!-- Preview Header -->
                <div class="p-3 border-b dark:border-gray-700 flex items-center justify-between shrink-0 bg-gray-50 dark:bg-gray-900">
                    <div class="flex items-center gap-3">
                        <button @click="selectedMockup = null; selectedElement = null; previewHtml = ''; window.dispatchEvent(new CustomEvent('mockup-context-changed', { detail: { mockup_id: null, mockup_project_id: null } }))"
                                class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                title="Torna alla lista">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <div>
                            <h3 class="font-semibold flex items-center gap-2">
                                <span x-text="selectedMockup.name"></span>
                                <span x-show="selectedMockup.version > 1"
                                      class="px-1.5 py-0.5 rounded text-xs font-medium bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300">
                                    v<span x-text="selectedMockup.version"></span>
                                </span>
                            </h3>
                            <!-- Mockup ID (small, italic, muted) -->
                            <p class="text-[10px] italic text-gray-400 dark:text-gray-500" x-text="selectedMockup.id"></p>
                            <p class="text-xs text-gray-500" x-text="selectedMockup.component_type + ' • ' + selectedMockup.llm_type"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="px-2 py-1 rounded text-xs"
                              :class="{
                                  'bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300': selectedMockup.llm_type === 'claude',
                                  'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300': selectedMockup.llm_type === 'gemini',
                                  'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300': selectedMockup.llm_type === 'grok'
                              }"
                              x-text="selectedMockup.llm_type"></span>
                        <button @click="window.open('/mockups/' + selectedMockup.id + '/preview', '_blank')"
                                class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                title="Apri in nuova tab">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                        </button>
                        <button @click="downloadMockup(selectedMockup)"
                                class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                title="Download HTML">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Preview iframe (full width) -->
                <div class="flex-1 bg-white dark:bg-gray-900 overflow-hidden relative">
                    <iframe
                        x-ref="previewFrame"
                        class="w-full h-full bg-white"
                        :srcdoc="previewHtml || '<div class=&quot;flex items-center justify-center h-full text-gray-400&quot;>Caricamento preview...</div>'"
                        sandbox="allow-scripts"
                        @load="setupPreviewClickHandler()"></iframe>

                    <!-- Overlay hint -->
                    <div x-show="!selectedElement"
                         class="absolute bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-black/70 text-white text-sm rounded-full backdrop-blur-sm pointer-events-none">
                        Clicca su un elemento per modificarlo
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="p-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900 shrink-0">
                    <div class="flex items-center justify-between">
                        <!-- Selected element info -->
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <template x-if="selectedElement">
                                <div class="flex items-center gap-2 flex-1 min-w-0">
                                    <div class="px-3 py-1.5 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 rounded-lg text-sm font-mono truncate max-w-md"
                                         x-text="selectedElement"></div>
                                    <button @click="showEditComponentModal = true"
                                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center gap-2 shrink-0">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                        Modifica Componente
                                    </button>
                                </div>
                            </template>
                            <template x-if="!selectedElement">
                                <span class="text-gray-400 text-sm">Seleziona un elemento nel preview per modificarlo</span>
                            </template>
                        </div>

                        <!-- Quick actions -->
                        <div class="flex items-center gap-2 ml-4">
                            <button @click="modifyMockup(selectedMockup.id)"
                                    class="px-4 py-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-sm">
                                Modifica Pagina Intera
                            </button>
                            <button @click="deleteMockup(selectedMockup)"
                                    class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                                    title="Elimina mockup">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- ============================================ -->
        <!-- NORMAL 3-COLUMN LAYOUT (no mockup selected) -->
        <!-- ============================================ -->
        <template x-if="!selectedMockup">
            <div class="flex-1 flex gap-4">
                <!-- Left: Projects Panel (for selected repo from global context) -->
                <div class="w-64 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col shrink-0">
            <div class="p-3 border-b dark:border-gray-700">
                <h3 class="font-semibold text-sm">Progetti</h3>
            </div>
            <div class="flex-1 overflow-y-auto p-2">
                <!-- No repo selected -->
                <template x-if="!$store.globalContext?.selectedRepoId">
                    <div class="text-center py-8 text-gray-400 text-sm">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <p>Seleziona un repository</p>
                        <p class="mt-1 text-xs">Usa il selettore in basso</p>
                    </div>
                </template>

                <!-- Repo selected: show projects -->
                <template x-if="$store.globalContext?.selectedRepoId">
                    <div class="space-y-1">
                        <!-- All mockups option -->
                        <button @click="clearProjectSelection()"
                                class="w-full flex items-center gap-2 px-2 py-1.5 rounded text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                :class="!selectedProject ? 'bg-primary/10 text-primary' : ''">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                            </svg>
                            <span>Tutti i mockup</span>
                        </button>

                        <!-- Project list -->
                        <template x-for="project in projects" :key="project.id">
                            <button @click="selectProject(project)"
                                    class="w-full flex items-center gap-2 px-2 py-1.5 rounded text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                    :class="selectedProject?.id === project.id ? 'bg-primary/10 text-primary' : ''">
                                <div class="w-3 h-3 rounded shrink-0" :style="`background-color: ${project.color}`"></div>
                                <div class="flex-1 min-w-0 text-left">
                                    <span class="truncate block" x-text="project.name"></span>
                                    <!-- Project ID (small, italic, muted) -->
                                    <span class="text-[9px] italic text-gray-400 dark:text-gray-500 truncate block" x-text="project.id"></span>
                                </div>
                                <span class="ml-auto text-xs text-gray-400 shrink-0" x-text="project.mockup_count"></span>
                            </button>
                        </template>

                        <!-- New project button -->
                        <button @click="showNewProjectModal = true"
                                class="w-full flex items-center gap-2 px-2 py-1.5 rounded text-sm text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 mt-2 border-t dark:border-gray-700 pt-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            <span>Nuovo progetto</span>
                        </button>

                        <!-- Empty projects state -->
                        <div x-show="projects.length === 0" class="text-center py-4 text-gray-400 text-xs mt-4">
                            <p>Nessun progetto</p>
                            <p class="mt-1">Crea il primo progetto</p>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Center: Mockup Grid -->
        <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col min-w-0">
            <div class="p-3 border-b dark:border-gray-700 flex items-center justify-between">
                <h3 class="font-semibold text-sm" x-text="selectedProject ? selectedProject.name : 'Tutti i Mockup'"></h3>
                <div class="flex gap-2">
                    <button @click="viewMode = 'grid'"
                            class="p-1.5 rounded"
                            :class="viewMode === 'grid' ? 'bg-gray-100 dark:bg-gray-700' : 'hover:bg-gray-100 dark:hover:bg-gray-700'">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                    </button>
                    <button @click="viewMode = 'list'"
                            class="p-1.5 rounded"
                            :class="viewMode === 'list' ? 'bg-gray-100 dark:bg-gray-700' : 'hover:bg-gray-100 dark:hover:bg-gray-700'">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <!-- Loading -->
                <div x-show="loading" class="flex items-center justify-center h-32">
                    <svg class="animate-spin w-8 h-8 text-primary" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>

                <!-- Empty state -->
                <div x-show="!loading && mockups.length === 0" class="text-center py-12">
                    <svg class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">Nessun mockup</h3>
                    <p class="text-gray-400 dark:text-gray-500 mt-1">Genera il tuo primo mockup con /mockup nella chat</p>
                    <button @click="openMockupChat()" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        Genera Mockup
                    </button>
                </div>

                <!-- Grid View -->
                <div x-show="!loading && viewMode === 'grid'"
                     class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="mockup in mockups" :key="mockup.id">
                        {% include "components/mockup_card.html" %}
                    </template>
                </div>

                <!-- List View -->
                <div x-show="!loading && viewMode === 'list'" class="space-y-2">
                    <template x-for="mockup in mockups" :key="mockup.id">
                        {% include "components/mockup_row.html" %}
                    </template>
                </div>
                </div>
            </div>
        </div>
        </template>
    </div>

    <!-- Edit Component Modal -->
    <div x-show="showEditComponentModal"
         x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
         @click.self="showEditComponentModal = false"
         @keydown.escape.window="showEditComponentModal = false">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             @click.stop>
            <!-- Header -->
            <div class="p-4 border-b dark:border-gray-700 bg-gradient-to-r from-indigo-500 to-purple-500">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Modifica Componente
                </h3>
            </div>

            <!-- Content -->
            <div class="p-5 space-y-4">
                <!-- Selected Element -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Elemento selezionato</label>
                    <div class="px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg font-mono text-sm text-indigo-600 dark:text-indigo-400 truncate"
                         x-text="selectedElement"></div>
                </div>

                <!-- Mockup Info -->
                <div class="flex gap-4 text-sm">
                    <div class="flex-1">
                        <span class="text-gray-500">Mockup:</span>
                        <span class="ml-1 font-medium" x-text="selectedMockup?.name"></span>
                    </div>
                    <div>
                        <span class="text-gray-500">Pagina:</span>
                        <span class="ml-1 font-medium" x-text="selectedMockup?.component_type"></span>
                    </div>
                </div>

                <!-- Description textarea -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Descrivi la modifica
                    </label>
                    <textarea x-model="editComponentDescription"
                              x-ref="editTextarea"
                              @keydown.enter.meta="sendComponentEdit()"
                              @keydown.enter.ctrl="sendComponentEdit()"
                              rows="4"
                              class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                              placeholder="Es: Cambia il colore del bottone in verde, aumenta il font size del titolo..."></textarea>
                    <p class="text-xs text-gray-400 mt-1">Premi Cmd+Enter (Mac) o Ctrl+Enter (Win) per inviare</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="px-5 pb-5 flex gap-3">
                <button @click="showEditComponentModal = false; editComponentDescription = ''"
                        class="flex-1 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Annulla
                </button>
                <button @click="sendComponentEdit()"
                        :disabled="!editComponentDescription.trim()"
                        class="flex-1 px-4 py-2.5 bg-primary text-white rounded-xl font-medium hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    Invia alla Chat
                </button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    {% include "components/mockup_project_modal.html" %}

    <!-- Select Project Modal -->
    <div x-show="showSelectProjectModal"
         x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
         @click.self="showSelectProjectModal = false">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md mx-4"
             @click.stop>
            <div class="p-4 border-b dark:border-gray-700">
                <h3 class="text-lg font-semibold">Seleziona Progetto</h3>
            </div>
            <div class="p-4">
                <!-- Search -->
                <input type="text"
                       x-model="projectSearchQuery"
                       placeholder="Cerca progetto..."
                       class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 mb-3 focus:ring-2 focus:ring-primary focus:border-transparent">
                <!-- Project list -->
                <div class="max-h-64 overflow-y-auto space-y-1">
                    <template x-for="project in filteredProjects" :key="project.id">
                        <button @click="selectProjectAndStartChat(project)"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <div class="font-medium" x-text="project.name"></div>
                            <div class="text-xs text-gray-500" x-text="project.description || 'Nessuna descrizione'"></div>
                        </button>
                    </template>
                    <div x-show="filteredProjects.length === 0" class="text-center text-gray-500 py-4">
                        Nessun progetto trovato
                    </div>
                </div>
            </div>
            <div class="p-4 border-t dark:border-gray-700 flex justify-between">
                <button @click="showSelectProjectModal = false; showNewProjectModal = true"
                        class="px-4 py-2 text-primary hover:underline">
                    + Nuovo Progetto
                </button>
                <button @click="showSelectProjectModal = false"
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal"
         x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
         @click.self="showDeleteModal = false">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             @click.stop>
            <!-- Icon -->
            <div class="pt-6 pb-2 flex justify-center">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </div>
            </div>
            <!-- Content -->
            <div class="px-6 pb-4 text-center">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Elimina Mockup</h3>
                <p class="mt-2 text-gray-500 dark:text-gray-400">
                    Stai per eliminare <span class="font-medium text-gray-700 dark:text-gray-300" x-text="mockupToDelete?.name"></span>.
                    Questa azione non può essere annullata.
                </p>
            </div>
            <!-- Actions -->
            <div class="px-6 pb-6 flex gap-3">
                <button @click="showDeleteModal = false; mockupToDelete = null"
                        :disabled="deleting"
                        class="flex-1 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors disabled:opacity-50">
                    Annulla
                </button>
                <button @click="confirmDeleteMockup()"
                        :disabled="deleting"
                        class="flex-1 px-4 py-2.5 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors disabled:opacity-50 flex items-center justify-center gap-2">
                    <svg x-show="deleting" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span x-text="deleting ? 'Eliminando...' : 'Elimina'"></span>
                </button>
            </div>
        </div>
    </div>

</div>

<script>
function mockupsPage() {
    return {
        projects: [],
        mockups: [],
        loading: false,
        viewMode: 'grid',
        selectedProject: null,
        selectedMockup: null,
        selectedElement: null,
        showNewProjectModal: false,
        newProjectName: '',
        newProjectDescription: '',
        newProjectDesignSystem: 'tailwind',
        creatingProject: false,
        // Delete confirmation modal
        showDeleteModal: false,
        mockupToDelete: null,
        deleting: false,
        // Preview state
        previewHtml: '',
        // Edit component modal
        showEditComponentModal: false,
        editComponentDescription: '',
        // Project selection modal
        showSelectProjectModal: false,
        projectSearchQuery: '',

        async init() {
            // Load data for selected repo
            await this.loadProjects();
            await this.loadMockups();

            // Watch for global context changes (repo selection)
            window.addEventListener('global-context-changed', async (e) => {
                console.log('[mockupsPage] Global context changed:', e.detail);
                // Reset selection and reload data for new repo
                this.selectedProject = null;
                this.selectedMockup = null;
                await this.loadProjects();
                await this.loadMockups();
            });

            // Listen for element selection from preview iframe
            window.addEventListener('message', (e) => {
                if (e.data && e.data.type === 'element-selected') {
                    this.selectedElement = e.data.selector;
                }
            });

            // SSE for real-time mockup updates (replaces polling)
            this._setupSSE();
        },

        _setupSSE() {
            this._eventSource = new EventSource('/api/mockups/events');

            this._eventSource.onmessage = async (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[mockupsPage] SSE event:', data);

                    if (data.type === 'init' || data.type === 'save') {
                        // Reload mockups list
                        await this.loadMockups();

                        // Auto-refresh preview if the modified mockup is currently selected
                        if (data.type === 'save' && this.selectedMockup && data.mockup_id === this.selectedMockup.id) {
                            console.log('[mockupsPage] Refreshing preview for modified mockup:', data.mockup_id);
                            // Re-select to reload preview HTML
                            await this.selectMockup(this.selectedMockup);
                            // Show toast notification
                            window.dispatchEvent(new CustomEvent('show-toast', {
                                detail: { message: 'Preview aggiornato!', type: 'success' }
                            }));
                        }
                    }

                } catch (e) {
                    console.error('[mockupsPage] SSE parse error:', e);
                }
            };

            this._eventSource.onerror = (error) => {
                console.warn('[mockupsPage] SSE connection error, will retry');
            };

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (this._eventSource) this._eventSource.close();
            });
        },

        async loadProjects() {
            const repoId = Alpine.store('globalContext')?.selectedRepoId;
            if (!repoId) {
                this.projects = [];
                return;
            }
            try {
                const res = await fetch(`/api/mockups/projects?repository_id=${repoId}`);
                const data = await res.json();
                this.projects = data.items || [];
            } catch (e) {
                console.error('Failed to load projects:', e);
                this.projects = [];
            }
        },

        async loadMockups(projectId = null) {
            const repoId = Alpine.store('globalContext')?.selectedRepoId;
            if (!repoId) {
                this.mockups = [];
                return;
            }
            this.loading = true;
            try {
                let url = `/api/mockups?repository_id=${repoId}`;
                if (projectId) {
                    url += `&project_id=${projectId}`;
                }
                const res = await fetch(url);
                const data = await res.json();
                this.mockups = data.items || [];
            } catch (e) {
                console.error('Failed to load mockups:', e);
                this.mockups = [];
            } finally {
                this.loading = false;
            }
        },

        selectProject(project) {
            this.selectedProject = project;
            this.selectedMockup = null;
            this.loadMockups(project.id);
        },

        clearProjectSelection() {
            this.selectedProject = null;
            this.selectedMockup = null;
            this.loadMockups();
        },

        async selectMockup(mockup) {
            this.selectedMockup = mockup;
            this.selectedElement = null;
            this.previewHtml = '';

            // Notify chat about mockup context (for AI context)
            window.dispatchEvent(new CustomEvent('mockup-context-changed', {
                detail: {
                    mockup_id: mockup.id,
                    mockup_project_id: mockup.project_id,
                    mockup_name: mockup.name
                }
            }));

            // Fetch mockup content for preview
            try {
                const res = await fetch(`/api/mockups/${mockup.id}/content`);
                const content = await res.json();
                let html = content.html || '';

                // Inject click handler script directly into HTML
                const clickHandlerScript = `
<script>
document.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    // Remove previous highlight
    document.querySelectorAll('[data-tw-selected]').forEach(el => {
        el.style.outline = '';
        el.removeAttribute('data-tw-selected');
    });

    // Highlight clicked element
    e.target.style.outline = '3px solid #6366f1';
    e.target.style.outlineOffset = '2px';
    e.target.setAttribute('data-tw-selected', 'true');

    // Get unique selector
    const selector = getUniqueSelector(e.target);
    parent.postMessage({ type: 'element-selected', selector }, '*');
}, true);

function getUniqueSelector(el) {
    if (el.id) return '#' + el.id;

    const path = [];
    while (el && el.nodeType === Node.ELEMENT_NODE) {
        let selector = el.tagName.toLowerCase();

        if (el.className && typeof el.className === 'string') {
            const classes = el.className.split(' ')
                .filter(c => c && !c.startsWith('hover:') && !c.startsWith('dark:'))
                .slice(0, 2)
                .join('.');
            if (classes) selector += '.' + classes;
        }

        path.unshift(selector);
        if (path.length >= 3) break;
        el = el.parentElement;
    }

    return path.join(' > ');
}

// Add hover effect
document.addEventListener('mouseover', (e) => {
    if (!e.target.hasAttribute('data-tw-selected')) {
        e.target.style.outline = '2px dashed #a5b4fc';
    }
}, true);
document.addEventListener('mouseout', (e) => {
    if (!e.target.hasAttribute('data-tw-selected')) {
        e.target.style.outline = '';
    }
}, true);
<\/script>`;

                // Inject before </body> or at the end
                if (html.includes('</body>')) {
                    html = html.replace('</body>', clickHandlerScript + '</body>');
                } else {
                    html += clickHandlerScript;
                }

                this.previewHtml = html;
                console.log('[mockups] Loaded preview HTML with click handler, length:', html.length);
            } catch (e) {
                console.error('Failed to load mockup content:', e);
                this.previewHtml = '<div class="flex items-center justify-center h-full text-red-500">Errore nel caricamento</div>';
            }
        },

        setupPreviewClickHandler() {
            const iframe = this.$refs.previewFrame;
            if (!iframe || !iframe.contentWindow) return;

            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;

                // Inject click handler script for element selection
                const script = doc.createElement('script');
                script.textContent = `
                    document.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        // Remove previous highlight
                        document.querySelectorAll('[data-tw-selected]').forEach(el => {
                            el.style.outline = '';
                            el.removeAttribute('data-tw-selected');
                        });

                        // Highlight clicked element
                        e.target.style.outline = '2px solid #6366f1';
                        e.target.setAttribute('data-tw-selected', 'true');

                        // Get unique selector
                        const selector = getUniqueSelector(e.target);
                        parent.postMessage({ type: 'element-selected', selector }, '*');
                    }, true);

                    function getUniqueSelector(el) {
                        if (el.id) return '#' + el.id;

                        const path = [];
                        while (el && el.nodeType === Node.ELEMENT_NODE) {
                            let selector = el.tagName.toLowerCase();

                            if (el.className && typeof el.className === 'string') {
                                const classes = el.className.split(' ')
                                    .filter(c => c && !c.startsWith('hover:') && !c.startsWith('dark:'))
                                    .slice(0, 2)
                                    .join('.');
                                if (classes) selector += '.' + classes;
                            }

                            path.unshift(selector);
                            if (path.length >= 3) break;
                            el = el.parentElement;
                        }

                        return path.join(' > ');
                    }
                `;
                doc.body.appendChild(script);
            } catch (e) {
                console.log('Cannot access iframe content (sandbox restriction)');
            }
        },

        async createProject() {
            const repoId = Alpine.store('globalContext')?.selectedRepoId;
            if (!this.newProjectName.trim() || !repoId) return;

            this.creatingProject = true;
            try {
                const res = await fetch('/api/mockups/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        repository_id: repoId,
                        name: this.newProjectName,
                        description: this.newProjectDescription,
                        design_system: this.newProjectDesignSystem
                    })
                });

                if (res.ok) {
                    const project = await res.json();
                    this.projects.push(project);
                    this.showNewProjectModal = false;
                    this.newProjectName = '';
                    this.newProjectDescription = '';
                    this.newProjectDesignSystem = 'tailwind';

                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: { message: 'Progetto creato!', type: 'success' }
                    }));
                } else {
                    throw new Error('Failed to create project');
                }
            } catch (e) {
                TurboWrapError.handle('Create Mockup Project', e);
            } finally {
                this.creatingProject = false;
            }
        },

        deleteMockup(mockup) {
            // Open delete confirmation modal
            this.mockupToDelete = mockup;
            this.showDeleteModal = true;
        },

        async confirmDeleteMockup() {
            if (!this.mockupToDelete) return;

            this.deleting = true;
            try {
                const res = await fetch(`/api/mockups/${this.mockupToDelete.id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                this.mockups = this.mockups.filter(m => m.id !== this.mockupToDelete.id);
                if (this.selectedMockup?.id === this.mockupToDelete.id) {
                    this.selectedMockup = null;
                }
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { message: 'Mockup eliminato', type: 'success' }
                }));
            } catch (e) {
                TurboWrapError.handle('Delete Mockup', e, { mockupId: this.mockupToDelete?.id });
            } finally {
                this.deleting = false;
                this.showDeleteModal = false;
                this.mockupToDelete = null;
            }
        },

        openMockupChat() {
            if (!this.selectedProject) {
                if (this.projects.length === 0) {
                    // No projects exist - create one first
                    this.showNewProjectModal = true;
                } else {
                    // Show project selection modal
                    this.projectSearchQuery = '';
                    this.showSelectProjectModal = true;
                }
                return;
            }
            this._startMockupChat();
        },

        _startMockupChat() {
            const projectId = this.selectedProject.id;
            const projectName = this.selectedProject.name;
            const command = `/mockup --project-id ${projectId} --project-name "${projectName}"`;
            console.log('[mockups] Opening chat with command:', command);
            window.dispatchEvent(new CustomEvent('open-chat-with-command', {
                detail: { command, newSession: true }
            }));
        },

        selectProjectAndStartChat(project) {
            this.selectedProject = project;
            this.showSelectProjectModal = false;
            this._startMockupChat();
        },

        get filteredProjects() {
            if (!this.projectSearchQuery) return this.projects;
            const q = this.projectSearchQuery.toLowerCase();
            return this.projects.filter(p => p.name.toLowerCase().includes(q));
        },

        modifyMockup(mockupId) {
            // Open chat with modify context (full page modification)
            window.dispatchEvent(new CustomEvent('open-chat-with-command', {
                detail: {
                    command: `/mockup_modify --mockup-id ${mockupId} --selector "body" --description "Modifica la pagina intera secondo le istruzioni che seguono:"`,
                    reuseSession: true
                }
            }));
        },

        sendComponentEdit() {
            if (!this.editComponentDescription.trim() || !this.selectedMockup || !this.selectedElement) return;

            const mockupId = this.selectedMockup.id;
            const selector = this.selectedElement;
            const description = this.editComponentDescription.trim();

            // Comando semplice con argomenti strutturati
            const message = `/mockup_modify --mockup-id ${mockupId} --selector "${selector}" --description "${description}"`;

            // Dispatch event to chat
            window.dispatchEvent(new CustomEvent('open-chat-with-command', {
                detail: {
                    command: message,
                    reuseSession: true
                }
            }));

            // Close modal and reset
            this.showEditComponentModal = false;
            this.editComponentDescription = '';

            window.dispatchEvent(new CustomEvent('show-toast', {
                detail: { message: 'Richiesta inviata alla chat', type: 'success' }
            }));
        },

        async downloadMockup(mockup) {
            try {
                const res = await fetch(`/api/mockups/${mockup.id}/content`);
                const data = await res.json();

                const blob = new Blob([data.html_content], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${mockup.name.replace(/[^a-z0-9]/gi, '_')}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error('Failed to download mockup:', e);
            }
        },

        formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        },

        formatTokens(tokensIn, tokensOut) {
            const inK = tokensIn ? Math.round(tokensIn / 1000) : 0;
            const outK = tokensOut ? Math.round(tokensOut / 1000) : 0;
            return `${inK}K / ${outK}K`;
        }
    }
}
</script>
{% endblock %}
