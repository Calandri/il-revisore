<!-- React Chat Widget Mount Point -->
<!-- This template replaces the Alpine.js chat sidebar with the React-based @turbowrap/chat -->

<!-- Chat Widget Container -->
<div id="turbowrap-chat-root"
     x-data="{}"
     x-init="$nextTick(() => window.mountTurboWrapChat && window.mountTurboWrapChat())"
     class="fixed right-0 top-0 h-full z-[60]"
     :class="{
         'w-full md:w-[calc(100vw-4rem)]': $store.global?.chatMode === 'page',
         'w-full md:w-[520px]': $store.global?.chatMode === 'full',
         'w-full md:w-[340px]': $store.global?.chatMode === 'third',
         'hidden': $store.global?.chatMode === 'hidden'
     }">
</div>

<!-- React + ReactDOM (production builds) -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<!-- TurboWrap Chat Widget -->
<link rel="stylesheet" href="{{ url_for('static', path='chat/style.css') }}">
<script src="{{ url_for('static', path='chat/turbowrap-chat.umd.js') }}"></script>

<script>
(function() {
  'use strict';

  /**
   * Mount the TurboWrap Chat React widget
   * Integrates with the existing Alpine.js global store
   */
  window.mountTurboWrapChat = function() {
    const container = document.getElementById('turbowrap-chat-root');
    if (!container || !window.TurboWrapChat || !window.React || !window.ReactDOM) {
      console.warn('[TurboWrapChat] Dependencies not loaded, retrying in 100ms...');
      setTimeout(window.mountTurboWrapChat, 100);
      return;
    }

    // Access Alpine global store
    const getGlobalStore = () => {
      if (window.Alpine && window.Alpine.store) {
        return window.Alpine.store('global');
      }
      return null;
    };

    // Get auth token from session/cookie
    const getAuthToken = () => {
      // Try to get from Cognito/localStorage first
      const cognitoToken = localStorage.getItem('id_token');
      if (cognitoToken) return cognitoToken;

      // Fall back to session cookie
      return document.cookie
        .split('; ')
        .find(row => row.startsWith('session='))
        ?.split('=')[1] || '';
    };

    // Build global context from Alpine store
    const buildGlobalContext = () => {
      const store = getGlobalStore();
      if (!store) return {};

      return {
        repositoryId: store.currentRepo?.id,
        repositoryName: store.currentRepo?.name,
        currentBranch: store.currentBranch,
        branches: store.branches || [],
      };
    };

    // Build repositories list
    const getRepositories = () => {
      const store = getGlobalStore();
      if (!store || !store.repositories) return [];

      return store.repositories.map(repo => ({
        id: repo.id,
        name: repo.name,
        fullName: repo.full_name || repo.name,
        path: repo.path,
        defaultBranch: repo.default_branch || 'main',
      }));
    };

    // Widget configuration
    const config = {
      baseUrl: window.location.origin,
      getAuthToken: getAuthToken,
      defaultCliType: 'claude',
      defaultMode: 'third',
      theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light',
      enableSharedWorker: true,
      workerUrl: '/static/js/chat-worker.js',

      // Callbacks for integration
      onNavigate: (path) => {
        // Use HTMX or standard navigation
        if (window.htmx) {
          htmx.ajax('GET', path, { target: '#main-content', swap: 'innerHTML' });
        } else {
          window.location.href = path;
        }
      },

      onHighlight: (selector) => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          el.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2', 'animate-pulse');
          setTimeout(() => {
            el.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-2', 'animate-pulse');
          }, 3000);
        });
      },

      onSessionCreate: (session) => {
        console.log('[TurboWrapChat] Session created:', session.id);
      },

      onError: (error) => {
        console.error('[TurboWrapChat] Error:', error);
        // Show toast notification if available
        if (window.showToast) {
          window.showToast(error.message, 'error');
        }
      },
    };

    // Create React element
    const { createElement } = React;
    const { ChatWidget } = TurboWrapChat;

    // Render function
    const render = () => {
      const element = createElement(ChatWidget, {
        config: config,
        globalContext: buildGlobalContext(),
        repositories: getRepositories(),
        onClose: () => {
          const store = getGlobalStore();
          if (store) store.chatMode = 'hidden';
        },
        onExpand: () => {
          const store = getGlobalStore();
          if (store) {
            store.chatMode = store.chatMode === 'full' ? 'third' : 'full';
          }
        },
      });

      const root = ReactDOM.createRoot(container);
      root.render(element);

      // Store root for cleanup
      container._reactRoot = root;
    };

    // Initial render
    render();

    // Listen for global context changes
    window.addEventListener('turbowrap:context-changed', () => {
      if (container._reactRoot) {
        render();
      }
    });

    // Listen for repo change events from the widget
    window.addEventListener('turbowrap:repo-change', (event) => {
      const { repositoryId } = event.detail;
      const store = getGlobalStore();
      if (store && repositoryId) {
        // Find the repo and update the global store
        const repo = store.repositories?.find(r => r.id === repositoryId);
        if (repo) {
          store.currentRepo = repo;
          store.currentBranch = repo.default_branch || 'main';
          // Trigger context change event
          window.dispatchEvent(new CustomEvent('turbowrap:context-changed'));
        }
      }
    });

    console.log('[TurboWrapChat] React widget mounted successfully');
  };

  // Auto-mount when DOM is ready
  if (document.readyState === 'complete') {
    window.mountTurboWrapChat();
  } else {
    window.addEventListener('load', window.mountTurboWrapChat);
  }
})();
</script>

<style>
/* TurboWrap Chat Widget Styles */
#turbowrap-chat-root {
  font-family: system-ui, -apple-system, sans-serif;
}

#turbowrap-chat-root .turbowrap-chat {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: white;
  box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
  border-left: 1px solid #e5e7eb;
}

.dark #turbowrap-chat-root .turbowrap-chat {
  background: #111827;
  border-left-color: #374151;
}

/* Animation for highlighted elements */
@keyframes turbowrap-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
.animate-pulse {
  animation: turbowrap-pulse 1s ease-in-out infinite;
}
</style>
