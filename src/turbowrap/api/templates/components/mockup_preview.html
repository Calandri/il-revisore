<!-- Mockup Preview Panel -->
<template x-if="selectedMockup">
    <div class="h-full flex flex-col">
        <!-- Header -->
        <div class="p-3 border-b dark:border-gray-700 flex items-center justify-between shrink-0">
            <div class="flex items-center gap-2 min-w-0">
                <h3 class="font-semibold text-sm truncate" x-text="selectedMockup.name"></h3>
                <span x-show="selectedMockup.version > 1"
                      class="px-1.5 py-0.5 rounded text-xs font-medium bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 shrink-0">
                    v<span x-text="selectedMockup.version"></span>
                </span>
            </div>
            <button @click="selectedMockup = null" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded shrink-0">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Preview iframe -->
        <div class="flex-1 bg-white dark:bg-gray-900 p-2 overflow-hidden">
            <iframe
                x-ref="previewFrame"
                class="w-full h-full rounded border border-gray-200 dark:border-gray-600 bg-white"
                :srcdoc="previewHtml || '<div class=&quot;flex items-center justify-center h-full text-gray-400&quot;>Caricamento preview...</div>'"
                sandbox="allow-scripts"
                @load="setupPreviewClickHandler()"></iframe>
        </div>

        <!-- Element Selector -->
        <div class="p-3 border-t dark:border-gray-700 shrink-0">
            <div class="text-xs text-gray-500 mb-2">Seleziona elemento per modificare:</div>
            <div class="px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded text-sm font-mono truncate"
                 x-text="selectedElement || 'Clicca su un elemento nel preview'"></div>
        </div>

        <!-- Mockup Info -->
        <div class="p-3 border-t dark:border-gray-700 space-y-2 shrink-0">
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-500">Tipo:</span>
                <span class="text-gray-700 dark:text-gray-300" x-text="selectedMockup.component_type || 'component'"></span>
            </div>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-500">LLM:</span>
                <span class="px-2 py-0.5 rounded"
                      :class="{
                          'bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300': selectedMockup.llm_type === 'claude',
                          'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300': selectedMockup.llm_type === 'gemini',
                          'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300': selectedMockup.llm_type === 'grok'
                      }"
                      x-text="selectedMockup.llm_type"></span>
            </div>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-500">Token:</span>
                <span class="text-gray-700 dark:text-gray-300" x-text="formatTokens(selectedMockup.tokens_in, selectedMockup.tokens_out)"></span>
            </div>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-500">Creato:</span>
                <span class="text-gray-700 dark:text-gray-300" x-text="formatDate(selectedMockup.created_at)"></span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="p-3 border-t dark:border-gray-700 space-y-2 shrink-0">
            <button @click="modifyMockup(selectedMockup.id)"
                    class="w-full px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm transition-colors">
                <span class="flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Modifica con AI
                </span>
            </button>

            <div class="flex gap-2">
                <button @click="window.open('/mockups/' + selectedMockup.id + '/preview', '_blank')"
                        class="flex-1 px-3 py-2 bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 text-sm transition-colors">
                    Apri in Tab
                </button>
                <button @click="downloadMockup(selectedMockup)"
                        class="px-3 py-2 bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 text-sm transition-colors"
                        title="Download HTML">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</template>

<script>
// Extend mockupsPage with preview functionality
document.addEventListener('alpine:init', () => {
    Alpine.data('mockupsPage', (data) => ({
        ...data,
        previewHtml: '',

        async selectMockup(mockup) {
            this.selectedMockup = mockup;
            this.selectedElement = null;
            this.previewHtml = '';

            // Fetch content
            try {
                const res = await fetch(`/api/mockups/${mockup.id}/content`);
                const content = await res.json();
                this.previewHtml = content.html_content;
            } catch (e) {
                console.error('Failed to load mockup content:', e);
                this.previewHtml = '<div class="flex items-center justify-center h-full text-red-500">Errore nel caricamento</div>';
            }
        },

        setupPreviewClickHandler() {
            const iframe = this.$refs.previewFrame;
            if (!iframe || !iframe.contentWindow) return;

            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;

                // Inject click handler script
                const script = doc.createElement('script');
                script.textContent = `
                    document.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        // Remove previous highlight
                        document.querySelectorAll('[data-tw-selected]').forEach(el => {
                            el.style.outline = '';
                            el.removeAttribute('data-tw-selected');
                        });

                        // Highlight clicked element
                        e.target.style.outline = '2px solid #6366f1';
                        e.target.setAttribute('data-tw-selected', 'true');

                        // Get unique selector
                        const selector = getUniqueSelector(e.target);
                        parent.postMessage({ type: 'element-selected', selector }, '*');
                    }, true);

                    function getUniqueSelector(el) {
                        if (el.id) return '#' + el.id;

                        const path = [];
                        while (el && el.nodeType === Node.ELEMENT_NODE) {
                            let selector = el.tagName.toLowerCase();

                            if (el.className && typeof el.className === 'string') {
                                const classes = el.className.split(' ')
                                    .filter(c => c && !c.startsWith('hover:') && !c.startsWith('dark:'))
                                    .slice(0, 2)
                                    .join('.');
                                if (classes) selector += '.' + classes;
                            }

                            path.unshift(selector);
                            if (path.length >= 3) break;
                            el = el.parentElement;
                        }

                        return path.join(' > ');
                    }
                `;
                doc.body.appendChild(script);
            } catch (e) {
                console.log('Cannot access iframe content (sandbox restriction)');
            }
        }
    }));
});

// Listen for element selection from iframe
window.addEventListener('message', (e) => {
    if (e.data && e.data.type === 'element-selected') {
        const pageData = Alpine.$data(document.querySelector('[x-data*="mockupsPage"]'));
        if (pageData) {
            pageData.selectedElement = e.data.selector;
        }
    }
});
</script>
