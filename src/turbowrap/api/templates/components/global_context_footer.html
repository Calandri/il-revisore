<!-- Global Context Footer - Status Bar -->
<footer x-data="globalContextFooter()"
        x-init="init()"
        id="global-context-footer"
        class="fixed bottom-0 left-0 right-0 z-40 h-6 bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-600 text-white text-xs flex items-center transition-all duration-300 select-none"
        :class="{
            'md:ml-64': sidebarOpen,
            'md:ml-16': !sidebarOpen,
            'md:mr-[520px]': chatMode === 'full',
            'md:mr-[340px]': chatMode === 'third',
            'ring-2 ring-white ring-offset-2 ring-offset-purple-600': highlighted
        }"
        @highlight-footer.window="highlight()"

    <!-- Left section: Repo + Branch -->
    <div class="flex items-center h-full">
        <!-- Repository Selector -->
        <div class="relative h-full">
            <button @click="showRepoDropdown = !showRepoDropdown"
                    @click.outside="showRepoDropdown = false"
                    class="h-full px-2 flex items-center gap-1.5 hover:bg-white/10 transition-colors cursor-pointer">
                <!-- Git branch icon -->
                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5zm-2.25.75a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.492 2.492 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25zM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5zM3.5 3.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0z"/>
                </svg>
                <span x-text="$store.globalContext.selectedRepo?.name || 'Select repo'"
                      class="max-w-[120px] truncate"
                      :class="{ 'opacity-60': !$store.globalContext.selectedRepoId }"></span>
                <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>

            <!-- Repo Dropdown -->
            <div x-show="showRepoDropdown"
                 x-cloak
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="opacity-0 -translate-y-1"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="absolute bottom-full left-0 mb-0.5 w-56 max-h-64 overflow-y-auto bg-gray-900 border border-purple-500/30 rounded shadow-xl">
                <div class="py-1">
                    <button @click="selectRepo(null); showRepoDropdown = false"
                            class="w-full px-3 py-1.5 text-left text-xs hover:bg-purple-600/50 flex items-center gap-2"
                            :class="{ 'bg-purple-600/50': !$store.globalContext.selectedRepoId }">
                        <span class="opacity-60">No repository</span>
                    </button>
                    <template x-for="repo in $store.globalContext.repositories" :key="repo.id">
                        <button @click="selectRepo(repo.id); showRepoDropdown = false"
                                :disabled="repo.path_exists === false"
                                class="w-full px-3 py-1.5 text-left text-xs hover:bg-purple-600/50 flex items-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed"
                                :class="{ 'bg-purple-600/50': $store.globalContext.selectedRepoId === repo.id }">
                            <span x-text="repo.name" class="truncate"></span>
                            <span x-show="repo.path_exists === false" class="text-[10px] opacity-50">(not cloned)</span>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Separator -->
        <div x-show="$store.globalContext.selectedRepoId && $store.globalContext.hasClonedPath"
             class="w-px h-3 bg-white/20"></div>

        <!-- Branch Selector -->
        <div x-show="$store.globalContext.selectedRepoId && $store.globalContext.hasClonedPath"
             class="relative h-full">
            <button @click="showBranchDropdown = !showBranchDropdown"
                    @click.outside="showBranchDropdown = false"
                    class="h-full px-2 flex items-center gap-1.5 hover:bg-white/10 transition-colors cursor-pointer">
                <span x-text="$store.globalContext.selectedBranch || 'branch'"
                      class="max-w-[100px] truncate"></span>
                <svg x-show="$store.globalContext.branchesLoading" class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <svg x-show="!$store.globalContext.branchesLoading" class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>

            <!-- Branch Dropdown -->
            <div x-show="showBranchDropdown"
                 x-cloak
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="opacity-0 -translate-y-1"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="absolute bottom-full left-0 mb-0.5 w-48 max-h-64 overflow-y-auto bg-gray-900 border border-purple-500/30 rounded shadow-xl">
                <div class="py-1">
                    <template x-for="branch in $store.globalContext.branches" :key="branch">
                        <button @click="selectBranch(branch); showBranchDropdown = false"
                                class="w-full px-3 py-1.5 text-left text-xs hover:bg-purple-600/50 flex items-center gap-2"
                                :class="{ 'bg-purple-600/50': $store.globalContext.selectedBranch === branch }">
                            <span x-text="branch" class="truncate"></span>
                            <span x-show="branch === syncStatus?.branch" class="text-[10px] opacity-50">(current)</span>
                        </button>
                    </template>
                    <div x-show="$store.globalContext.branches.length === 0" class="px-3 py-2 text-xs opacity-50">
                        No branches found
                    </div>
                </div>
            </div>
        </div>

        <!-- Separator -->
        <div x-show="$store.globalContext.selectedRepoId && syncStatus"
             class="w-px h-3 bg-white/20"></div>

        <!-- Sync Status (ahead/behind) -->
        <div x-show="$store.globalContext.selectedRepoId && syncStatus"
             class="h-full px-2 flex items-center gap-2">
            <!-- Sync indicator -->
            <button @click="refreshSyncStatus()"
                    :disabled="syncLoading"
                    class="flex items-center gap-1 hover:bg-white/10 px-1 rounded transition-colors"
                    :class="{ 'animate-pulse': syncLoading }">
                <!-- Sync icon -->
                <svg class="w-3.5 h-3.5" :class="{ 'animate-spin': syncLoading }" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
                <!-- Ahead -->
                <span x-show="syncStatus?.ahead > 0" class="flex items-center gap-0.5">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
                    </svg>
                    <span x-text="syncStatus?.ahead"></span>
                </span>
                <!-- Behind -->
                <span x-show="syncStatus?.behind > 0" class="flex items-center gap-0.5">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
                    </svg>
                    <span x-text="syncStatus?.behind"></span>
                </span>
                <!-- Synced indicator -->
                <span x-show="syncStatus?.ahead === 0 && syncStatus?.behind === 0" class="flex items-center gap-0.5 opacity-70">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
                    </svg>
                </span>
            </button>
            <!-- Dirty indicator -->
            <span x-show="syncStatus && !syncStatus.is_clean"
                  class="w-2 h-2 rounded-full bg-yellow-400"
                  title="Uncommitted changes"></span>
        </div>
    </div>

    <!-- Right section: spacer -->
    <div class="flex-1"></div>
</footer>

<script>
function globalContextFooter() {
    return {
        showRepoDropdown: false,
        showBranchDropdown: false,
        syncStatus: null,
        syncLoading: false,
        highlighted: false,

        get sidebarOpen() {
            const htmlData = Alpine.$data(document.documentElement);
            return htmlData?.sidebarOpen ?? (window.innerWidth >= 768);
        },

        get chatMode() {
            return localStorage.getItem('chatMode') || 'third';
        },

        async init() {
            // Initialize the global context store
            await Alpine.store('globalContext').init();

            // Load sync status if repo is already selected
            if (Alpine.store('globalContext').selectedRepoId) {
                await this.loadSyncStatus();
            }

            // Watch for repo changes to auto-load sync status
            this.$watch('$store.globalContext.selectedRepoId', async (repoId) => {
                if (repoId) {
                    await this.loadSyncStatus();
                } else {
                    this.syncStatus = null;
                }
            });

            // Watch for branch changes to refresh sync status
            this.$watch('$store.globalContext.selectedBranch', async (branch) => {
                if (branch && Alpine.store('globalContext').selectedRepoId) {
                    await this.loadSyncStatus();
                }
            });
        },

        async selectRepo(repoId) {
            await Alpine.store('globalContext').selectRepo(repoId);
        },

        async selectBranch(branch) {
            await Alpine.store('globalContext').selectBranch(branch);
        },

        highlight() {
            this.highlighted = true;
            setTimeout(() => {
                this.highlighted = false;
            }, 1500);
        },

        async loadSyncStatus() {
            const repoId = Alpine.store('globalContext').selectedRepoId;
            if (!repoId) return;

            this.syncLoading = true;
            try {
                const res = await fetch(`/api/git/repositories/${repoId}/status`);
                if (res.ok) {
                    this.syncStatus = await res.json();
                }
            } catch (e) {
                console.error('[globalContextFooter] Failed to load sync status:', e);
            } finally {
                this.syncLoading = false;
            }
        },

        async refreshSyncStatus() {
            await this.loadSyncStatus();
        },

        async pullIfBehind() {
            if (!this.syncStatus?.behind || this.syncStatus.behind === 0) {
                // Nothing to pull, just refresh status
                await this.loadSyncStatus();
                return;
            }

            const repoId = Alpine.store('globalContext').selectedRepoId;
            if (!repoId) return;

            this.syncLoading = true;
            try {
                const res = await fetch(`/api/git/repositories/${repoId}/pull`, {
                    method: 'POST'
                });
                const result = await res.json();

                if (result.success) {
                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: { message: 'Pull completed successfully', type: 'success' }
                    }));
                } else {
                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: { message: `Pull failed: ${result.message}`, type: 'error' }
                    }));
                }

                // Refresh status after pull
                await this.loadSyncStatus();
            } catch (e) {
                console.error('[globalContextFooter] Pull failed:', e);
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { message: 'Pull failed', type: 'error' }
                }));
            } finally {
                this.syncLoading = false;
            }
        }
    };
}
</script>
