<!-- Sidebar -->
<aside class="fixed left-0 top-0 h-full bg-white dark:bg-gray-800 shadow-lg transition-all duration-300 z-50
              max-md:w-[80%] max-md:max-w-[300px] max-md:transform max-md:transition-transform
              flex flex-col"
       :class="{
           'w-64': sidebarOpen,
           'w-16': !sidebarOpen,
           'max-md:translate-x-0': sidebarOpen,
           'max-md:-translate-x-full': !sidebarOpen
       }">

    <!-- Logo / Toggle -->
    <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
        <a href="/" class="flex items-center gap-2" x-show="sidebarOpen" @click="if(window.innerWidth < 768) sidebarOpen = false">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold">T</div>
            <span class="font-bold text-lg">TurboWrap</span>
        </a>
        <!-- Toggle button - hidden on mobile, visible on desktop -->
        <button @click="sidebarOpen = !sidebarOpen"
                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors hidden md:block">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
        <!-- Close button - visible only on mobile -->
        <button @click="sidebarOpen = false"
                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors md:hidden">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <!-- Scrollable content area -->
    <div class="flex-1 overflow-y-auto">
        <!-- Navigation -->
        <nav class="p-4 space-y-2">
        <!-- Dashboard -->
        <a href="/"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'dashboard' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            <span x-show="sidebarOpen">Dashboard</span>
        </a>

        <!-- Repository -->
        <a href="/repos"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'repos' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
            <span x-show="sidebarOpen">Repository</span>
        </a>

        <!-- Code Review -->
        <a href="/review"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'review' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
            </svg>
            <span x-show="sidebarOpen">Code Review</span>
        </a>

        <!-- Issues -->
        <a href="/issues"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'issues' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <span x-show="sidebarOpen">Issues</span>
        </a>

        <!-- Linear -->
        <a href="/linear"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'linear' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
            </svg>
            <span x-show="sidebarOpen">Linear</span>
        </a>

        <!-- File Editor -->
        <a href="/files"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'files' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            <span x-show="sidebarOpen">File Editor</span>
        </a>

        <!-- Chat -->
        <a href="/chat"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'chat' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <span x-show="sidebarOpen">Chat AI</span>
        </a>

        <!-- Tasks History -->
        <a href="/tasks"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'tasks' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <span x-show="sidebarOpen">Storico Task</span>
        </a>

        <!-- Users (admin only) -->
        {% if current_user and current_user.is_admin %}
        <a href="/users"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'users' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            <span x-show="sidebarOpen">Utenti</span>
        </a>
        {% endif %}

        <!-- System Status -->
        <a href="/system-status"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'status' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <span x-show="sidebarOpen">Status</span>
        </a>

        <!-- Settings -->
        <a href="/settings"
           @click="if(window.innerWidth < 768) sidebarOpen = false"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors
                  {% if active_page == 'settings' %}bg-primary text-white{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <span x-show="sidebarOpen">Impostazioni</span>
        </a>

        <!-- API Docs -->
        <a href="/docs" target="_blank"
           class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors hover:bg-gray-100 dark:hover:bg-gray-700">
            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span x-show="sidebarOpen">API Docs</span>
        </a>
    </nav>

    <!-- GitHub Recent Activity Widget -->
    <div x-data="githubActivityWidget()"
         x-show="!loading && repositories.length > 0"
         class="mx-4 mb-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform -translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0">

        <!-- Error state -->
        <div x-show="error" class="p-3 mb-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-red-600 dark:text-red-400 text-sm">
            <span x-text="'Errore: ' + error"></span>
        </div>

        <!-- Expanded view -->
        <div x-show="sidebarOpen" class="space-y-3">
            <template x-for="repo in repositories" :key="repo.id">
                <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
                    <!-- Repository Header -->
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-gray-600 dark:text-gray-400" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z"></path>
                            </svg>
                            <span class="text-sm font-medium text-gray-900 dark:text-white" x-text="repo.name"></span>
                        </div>
                        <button @click="toggleRepo(repo.id)"
                                class="text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            <svg x-show="!repo.expanded" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                            <svg x-show="repo.expanded" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Path warning if not exists -->
                    <div x-show="repo.path_exists === false" class="flex items-center gap-1 text-xs text-red-500 mb-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span>Path non esiste</span>
                    </div>

                    <!-- Branch Info -->
                    <div class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400 mb-2">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                        </svg>
                        <span x-text="repo.currentBranch || 'Loading...'"></span>
                    </div>

                    <!-- Recent Commits (collapsible) -->
                    <div x-show="repo.expanded" class="space-y-1.5 mt-2">
                        <div class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Recent commits:</div>
                        <template x-for="commit in repo.commits" :key="commit.sha">
                            <div @click="viewCommit(repo, commit)"
                                 class="text-xs p-2 rounded bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border border-gray-200 dark:border-gray-600">
                                <div class="font-mono text-blue-600 dark:text-blue-400 mb-1" x-text="commit.sha.substring(0, 7)"></div>
                                <div class="text-gray-700 dark:text-gray-300 line-clamp-2" x-text="commit.message"></div>
                                <div class="text-gray-500 mt-1 flex items-center gap-2">
                                    <span x-text="commit.author"></span>
                                    <span>•</span>
                                    <span x-text="commit.date"></span>
                                </div>
                            </div>
                        </template>
                        <div x-show="repo.commits.length === 0" class="text-xs text-gray-500 italic">No commits</div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Collapsed view -->
        <div x-show="!sidebarOpen" class="flex justify-center">
            <button class="w-8 h-8 bg-gray-600 text-white rounded-full flex items-center justify-center hover:bg-gray-700 transition-colors">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
            </button>
        </div>

        <!-- Commit Detail Modal -->
        <div x-show="selectedCommit"
             @click.away="selectedCommit = null"
             class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
             style="display: none;">
            <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-auto"
                 @click.stop>
                <div class="p-4 border-b dark:border-gray-700 flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-mono text-sm text-blue-600 dark:text-blue-400 mb-2" x-text="selectedCommit?.sha"></div>
                        <div class="font-medium" x-text="selectedCommit?.message"></div>
                        <div class="text-sm text-gray-500 mt-1">
                            <span x-text="selectedCommit?.author"></span> •
                            <span x-text="selectedCommit?.date"></span>
                        </div>
                    </div>
                    <button @click="selectedCommit = null" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="p-4">
                    <div class="text-sm font-medium mb-2">Changes:</div>
                    <pre class="text-xs bg-gray-50 dark:bg-gray-900 p-3 rounded overflow-x-auto" x-text="selectedCommit?.diff || 'Loading diff...'"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub Activity Widget Script -->
    <script>
    function githubActivityWidget() {
        return {
            repositories: [],
            selectedCommit: null,
            loading: true,
            error: null,

            get sidebarOpen() {
                return Alpine.store('sidebar')?.open ?? true;
            },

            async init() {
                await this.loadRepositories();
                // Poll every 30s to update
                setInterval(() => this.loadRepositories(), 30000);
            },

            async loadRepositories() {
                this.loading = true;
                this.error = null;
                try {
                    const res = await fetch('/api/git/repositories');
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                    }
                    const repos = await res.json();

                    // Preserve expanded state from existing repos
                    const expandedMap = {};
                    this.repositories.forEach(r => {
                        expandedMap[r.id] = r.expanded;
                    });

                    // Load branch and commits for each repo with Promise.all
                    const loadedRepos = await Promise.all(repos.map(async (repo) => {
                        repo.expanded = expandedMap[repo.id] ?? false;
                        repo.commits = [];
                        repo.currentBranch = 'Loading...';

                        if (repo.path_exists !== false) {
                            await Promise.all([
                                this.loadRepoBranchInline(repo),
                                this.loadRepoCommitsInline(repo)
                            ]);
                        } else {
                            repo.currentBranch = 'N/A';
                        }
                        return repo;
                    }));

                    this.repositories = loadedRepos;
                } catch (error) {
                    console.error('Error loading repositories:', error);
                    this.error = error.message;
                } finally {
                    this.loading = false;
                }
            },

            async loadRepoBranchInline(repo) {
                try {
                    const res = await fetch(`/api/git/repositories/${repo.id}/branch`);
                    if (res.ok) {
                        const data = await res.json();
                        repo.currentBranch = data.branch || 'N/A';
                    } else {
                        console.error(`Branch API error for ${repo.name}:`, res.status);
                        repo.currentBranch = 'N/A';
                    }
                } catch (error) {
                    console.error(`Error loading branch for ${repo.name}:`, error);
                    repo.currentBranch = 'Error';
                }
            },

            async loadRepoCommitsInline(repo) {
                try {
                    const res = await fetch(`/api/git/repositories/${repo.id}/commits?limit=5`);
                    if (res.ok) {
                        const commits = await res.json();
                        repo.commits = commits.map(c => ({
                            sha: c.sha,
                            message: c.message,
                            author: c.author,
                            date: this.formatDate(c.date)
                        }));
                    } else {
                        console.error(`Commits API error for ${repo.name}:`, res.status);
                        repo.commits = [];
                    }
                } catch (error) {
                    console.error(`Error loading commits for ${repo.name}:`, error);
                    repo.commits = [];
                }
            },

            toggleRepo(repoId) {
                this.repositories = this.repositories.map(r =>
                    r.id === repoId ? { ...r, expanded: !r.expanded } : r
                );
            },

            async viewCommit(repo, commit) {
                this.selectedCommit = {
                    ...commit,
                    diff: 'Loading diff...'
                };

                try {
                    const res = await fetch(`/api/git/repositories/${repo.id}/commits/${commit.sha}/diff`);
                    const data = await res.json();
                    this.selectedCommit.diff = data.diff;
                } catch (error) {
                    console.error('Error loading commit diff:', error);
                    this.selectedCommit.diff = 'Error loading diff';
                }
            },

            formatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            }
        }
    }
    </script>
    </div>

    <!-- Footer -->
    <div class="p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800">
        <div class="flex items-center justify-between">
            <!-- Logout -->
            <form action="/auth/logout" method="POST">
                <button type="submit"
                        class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 transition-colors">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <span x-show="sidebarOpen">Esci</span>
                </button>
            </form>

            <!-- Dark mode toggle (small icon) -->
            <button @click="darkMode = !darkMode"
                    class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-500 dark:text-gray-400">
                <svg x-show="!darkMode" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                </svg>
                <svg x-show="darkMode" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
            </button>
        </div>
    </div>
</aside>
