<!-- Active Operations Banner -->
<!-- This banner shows when CLI/system is performing operations on repositories -->
<div x-data="activeOperationsBanner()"
     x-init="startPolling()"
     x-show="operations.length > 0"
     x-effect="document.body.classList.toggle('has-active-banner', operations.length > 0)"
     x-cloak
     class="sticky top-0 left-0 right-0 z-[60] bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-600 text-white shadow-lg">

    <a href="/live-tasks"
       class="block px-4 py-2 hover:bg-white/10 transition-colors">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <!-- Left: Icon + Info -->
            <div class="flex items-center gap-3">
                <!-- Animated icon based on operation type -->
                <div class="relative">
                    <template x-if="operations.length === 1">
                        <span x-html="getOperationIcon(operations[0].type)"></span>
                    </template>
                    <template x-if="operations.length > 1">
                        <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </template>
                    <!-- Pulse ring -->
                    <span class="absolute inset-0 animate-ping opacity-30">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="8" stroke-width="2"/>
                        </svg>
                    </span>
                </div>

                <!-- Single operation info -->
                <template x-if="operations.length === 1">
                    <div class="flex flex-col gap-1">
                        <!-- Main info line -->
                        <div class="flex items-center gap-2 text-sm">
                            <span class="font-medium" x-text="operations[0].user_name || 'System'"></span>
                            <span class="opacity-80" x-text="getOperationVerb(operations[0].type)"></span>
                            <!-- Agent badge -->
                            <template x-if="operations[0].details?.agent">
                                <span class="bg-purple-500/30 px-2 py-0.5 rounded text-xs font-mono"
                                      x-text="operations[0].details.agent"></span>
                            </template>
                            <!-- Extra info for fix operations -->
                            <template x-if="operations[0].type === 'fix' && operations[0].details?.issue_count">
                                <span class="bg-white/20 px-2 py-0.5 rounded-full text-xs font-bold"
                                      x-text="operations[0].details.issue_count + ' issue' + (operations[0].details.issue_count !== 1 ? 's' : '')"></span>
                            </template>
                            <template x-if="operations[0].branch_name">
                                <span class="flex items-center gap-1">
                                    <span class="opacity-80">on</span>
                                    <code class="bg-black/20 px-2 py-0.5 rounded text-xs font-mono"
                                          x-text="operations[0].branch_name"></code>
                                </span>
                            </template>
                            <template x-if="operations[0].repository_name">
                                <span class="flex items-center gap-1">
                                    <span class="opacity-80">in</span>
                                    <span class="font-semibold" x-text="operations[0].repository_name"></span>
                                </span>
                            </template>
                            <!-- Model badge -->
                            <template x-if="operations[0].details?.model">
                                <span class="bg-blue-500/30 px-2 py-0.5 rounded text-xs"
                                      x-text="getModelShortName(operations[0].details.model)"></span>
                            </template>
                        </div>
                        <!-- Details line (prompt preview, S3 link) -->
                        <template x-if="operations[0].details?.prompt_preview || operations[0].details?.s3_prompt_url">
                            <div class="flex items-center gap-2 text-xs opacity-70">
                                <template x-if="operations[0].details?.prompt_preview">
                                    <span class="truncate max-w-md" x-text="operations[0].details.prompt_preview"></span>
                                </template>
                                <template x-if="operations[0].details?.s3_prompt_url">
                                    <a :href="operations[0].details.s3_prompt_url"
                                       target="_blank"
                                       @click.stop
                                       class="text-white/90 hover:text-white underline flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                        prompt
                                    </a>
                                </template>
                                <template x-if="operations[0].details?.prompt_length">
                                    <span class="text-white/50" x-text="'(' + operations[0].details.prompt_length.toLocaleString() + ' chars)'"></span>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Multiple operations -->
                <template x-if="operations.length > 1">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="bg-white/20 px-2 py-0.5 rounded-full text-xs font-bold"
                              x-text="operations.length + ' active operations'"></span>
                        <span class="opacity-80">across</span>
                        <!-- Show up to 3 repo names -->
                        <template x-for="(repo, index) in uniqueRepoNames.slice(0, 3)" :key="repo">
                            <span class="flex items-center">
                                <span class="font-semibold" x-text="repo"></span>
                                <span x-show="index < Math.min(uniqueRepoNames.length, 3) - 1" class="opacity-60 mx-1">,</span>
                            </span>
                        </template>
                        <!-- Show +N more if > 3 repos -->
                        <template x-if="uniqueRepoNames.length > 3">
                            <span class="opacity-70 text-xs" x-text="'+' + (uniqueRepoNames.length - 3) + ' more'"></span>
                        </template>
                    </div>
                </template>
            </div>

            <!-- Right: View details link -->
            <div class="flex items-center gap-2 text-sm opacity-80 hover:opacity-100 transition-opacity">
                <span>View details</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    </a>
</div>

<script>
function activeOperationsBanner() {
    return {
        operations: [],
        pollInterval: null,

        // Operation type labels
        operationLabels: {
            'fix': 'fixing issues',
            'review': 'reviewing',
            'git_merge': 'merging',
            'git_push': 'pushing',
            'git_pull': 'pulling',
            'clone': 'cloning',
            'sync': 'syncing',
            'promote': 'promoting to production',
            'deploy': 'deploying',
            'cli_task': 'running task',
        },

        get uniqueRepos() {
            const repos = new Set(this.operations.map(s => s.repository_id).filter(Boolean));
            return repos.size || 1;
        },

        get uniqueRepoNames() {
            // Get unique repo names from operations
            const names = [...new Set(
                this.operations
                    .map(s => s.repository_name)
                    .filter(Boolean)
            )];
            return names.length > 0 ? names : ['unknown'];
        },

        getOperationVerb(type) {
            return this.operationLabels[type] || type;
        },

        getModelShortName(model) {
            // Convert long model names to short display names
            if (!model) return '';
            if (model.includes('opus')) return 'opus';
            if (model.includes('sonnet')) return 'sonnet';
            if (model.includes('haiku')) return 'haiku';
            if (model.includes('flash')) return 'flash';
            if (model.includes('pro')) return 'pro';
            // Return last part after dash or full name if short
            const parts = model.split('-');
            return parts.length > 2 ? parts.slice(0, 2).join('-') : model;
        },

        getOperationIcon(type) {
            const icons = {
                'fix': `<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>`,
                'review': `<svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                </svg>`,
                'git_merge': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"/>
                </svg>`,
                'git_push': `<svg class="w-5 h-5 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"/>
                </svg>`,
                'git_pull': `<svg class="w-5 h-5 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"/>
                </svg>`,
                'clone': `<svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>`,
                'sync': `<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>`,
                'promote': `<svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>`,
                'cli_task': `<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>`,
            };
            return icons[type] || icons['fix'];
        },

        async fetchOperations() {
            try {
                console.log('[BANNER] Fetching operations...');
                const response = await fetch('/api/operations/active');
                if (response.ok) {
                    const data = await response.json();
                    console.log('[BANNER] Response:', data);
                    this.operations = data.operations || [];
                } else {
                    console.error('[BANNER] Response not ok:', response.status);
                }
            } catch (error) {
                console.error('[BANNER] Fetch error:', error);
            }
        },

        startPolling() {
            console.log('[BANNER] Starting polling...');
            // Initial fetch
            this.fetchOperations();
            // Poll every 5 seconds
            this.pollInterval = setInterval(() => {
                console.log('[BANNER] Polling tick');
                this.fetchOperations();
            }, 5000);

            // Listen for operation-started events to refresh immediately
            window.addEventListener('operation-started', () => {
                console.log('[BANNER] Received operation-started event, refreshing...');
                this.fetchOperations();
            });
        },

        stopPolling() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
            }
        }
    };
}
</script>

<style>
[x-cloak] { display: none !important; }
</style>
