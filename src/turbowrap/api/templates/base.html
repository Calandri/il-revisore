<!DOCTYPE html>
<html lang="it" x-data="{ sidebarOpen: window.innerWidth >= 768, darkMode: localStorage.getItem('darkMode') === 'true', chatMode: localStorage.getItem('chatMode') || 'third' }"
      :class="{ 'dark': darkMode }"
      x-init="
        $watch('darkMode', val => localStorage.setItem('darkMode', val));
        $watch('chatMode', val => localStorage.setItem('chatMode', val));
        // On mobile, chat is always fullscreen ('page') or hidden
        if (window.innerWidth < 768 && chatMode !== 'hidden') {
            chatMode = 'page';
        }
        // Reset chat to 'third' on desktop when not on chat page and it's in full/page mode
        if (window.innerWidth >= 768 && !window.location.pathname.startsWith('/chat') && (chatMode === 'full' || chatMode === 'page')) {
            chatMode = 'third';
        }
      ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TurboWrap{% endblock %}</title>

    <!-- Critical: Hide x-cloak elements immediately (before any CSS/JS loads) -->
    <style>[x-cloak] { display: none !important; }</style>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>

    <!-- Custom JS (MUST load before Alpine.js) -->
    <script src="/static/js/cli-chat.js?v=0.9.67"></script>
    <script src="/static/js/global-context.js?v=1.0.0"></script>

    <!-- Preload SharedWorkers for faster initialization -->
    <link rel="preload" href="/static/js/chat-worker.js" as="worker">
    <link rel="preload" href="/static/js/operation-worker.js" as="worker">

    <!-- Alpine.js Plugins (must load before main Alpine) -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/main.css">

    {% block head %}{% endblock %}
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <!-- Flex column layout: banner on top, rest takes remaining space -->
    <div class="flex flex-col h-screen">

    <!-- Active Fix Sessions Banner -->
    {% include "components/active_fix_banner.html" %}

    <!-- Mobile Header - visible only on mobile -->
    <header class="flex-shrink-0 sticky top-0 left-0 right-0 h-14 bg-white dark:bg-gray-800 border-b dark:border-gray-700 z-30 flex items-center justify-between px-4 md:hidden">
        <button @click="sidebarOpen = !sidebarOpen"
                class="p-2 -ml-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
        <div class="flex items-center gap-2">
            <div class="w-7 h-7 bg-primary rounded-lg flex items-center justify-center text-white font-bold text-sm">T</div>
            <span class="font-bold">TurboWrap</span>
        </div>
        <button @click="darkMode = !darkMode" class="p-2 -mr-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
            </svg>
            <svg x-show="darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
        </button>
    </header>

    <!-- Mobile sidebar backdrop -->
    <div x-show="sidebarOpen"
         x-transition:enter="transition-opacity ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="sidebarOpen = false"
         class="fixed inset-0 bg-black/50 z-40 md:hidden"></div>

    <!-- Toast notifications -->
    <div id="toast-container"
         x-data="toastManager()"
         @show-toast.window="show($event.detail)"
         class="fixed top-4 right-4 z-50 space-y-2">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-8"
                 x-transition:enter-end="opacity-100 transform translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 :class="toast.type === 'error' ? 'bg-red-500' : 'bg-green-500'"
                 class="text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2">
                <span x-text="toast.message"></span>
                <button @click="toast.visible = false" class="ml-2 hover:opacity-75">&times;</button>
            </div>
        </template>
    </div>

    <!-- Layout (takes remaining space after banner) -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Left Sidebar -->
        {% include "components/sidebar.html" %}

        <!-- Main content -->
        <main class="flex-1 overflow-auto transition-all duration-300 pb-8"
              :class="{
                  'md:ml-64': sidebarOpen,
                  'md:ml-16': !sidebarOpen,
                  'md:mr-[calc(100vw-4rem)]': chatMode === 'page',
                  'md:mr-[520px]': chatMode === 'full',
                  'md:mr-[340px]': chatMode === 'third'
              }">
            <div class="{% block content_wrapper_class %}p-6{% endblock %}">
                {% block content %}{% endblock %}
            </div>
        </main>

        <!-- Right Chat Sidebar -->
        {% include "components/chat_sidebar.html" %}
    </div>

    </div> <!-- End flex column layout -->

    <!-- Global Context Footer (Repo + Branch Selector) -->
    {% include "components/global_context_footer.html" %}

    <!-- Custom JS -->
    <script src="/static/js/app.js"></script>

    <!-- HTMX event handlers -->
    <script>
        document.body.addEventListener('showToast', function(evt) {
            window.dispatchEvent(new CustomEvent('show-toast', { detail: evt.detail }));
        });

        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.xhr.getResponseHeader('HX-Trigger')) {
                try {
                    const triggers = JSON.parse(evt.detail.xhr.getResponseHeader('HX-Trigger'));
                    if (triggers.showToast) {
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: triggers.showToast }));
                    }
                    if (triggers.showSyncError) {
                        const error = triggers.showSyncError.error;
                        if (error === 'token_expired') {
                            alert('TOKEN GITHUB SCADUTO!\n\nIl token GitHub non è più valido.\n\nPer risolvere:\n1. Vai su GitHub > Settings > Developer settings > Personal access tokens\n2. Genera un nuovo token\n3. Aggiorna il token nelle impostazioni del repository');
                        } else {
                            alert('Errore sincronizzazione:\n\n' + error);
                        }
                    }
                } catch(e) {}
            }
        });
    </script>

    {% block scripts %}{% endblock %}

    <!-- Global Operation Worker (for streaming operations) -->
    <script>
        // Initialize operation worker globally
        (function() {
            if (typeof SharedWorker === 'undefined') {
                console.warn('[OperationWorker] SharedWorker not supported in this browser');
                return;
            }

            // Create global worker instance
            window.operationWorker = new SharedWorker('/static/js/operation-worker.js');
            window.operationWorker.port.start();

            // Global event handler for operation updates
            window.operationWorker.port.onmessage = function(e) {
                const { type, operationId, ...data } = e.data;

                // Dispatch custom events for pages to listen to
                window.dispatchEvent(new CustomEvent('operation-worker-message', {
                    detail: { type, operationId, ...data }
                }));

                // Also dispatch specific events per type for convenience
                window.dispatchEvent(new CustomEvent(`operation-${type.toLowerCase()}`, {
                    detail: { operationId, ...data }
                }));
            };

            // Helper functions for easy access
            window.subscribeToOperation = function(operationId) {
                if (window.operationWorker) {
                    window.operationWorker.port.postMessage({ type: 'SUBSCRIBE', operationId });
                }
            };

            window.unsubscribeFromOperation = function(operationId) {
                if (window.operationWorker) {
                    window.operationWorker.port.postMessage({ type: 'UNSUBSCRIBE', operationId });
                }
            };

            window.getOperationState = function(operationId) {
                if (window.operationWorker) {
                    window.operationWorker.port.postMessage({ type: 'GET_STATE', operationId });
                }
            };

            console.log('[OperationWorker] Global worker initialized');
        })();
    </script>

    <!-- Issue Widget -->
    <script>
        window.IssueWidgetConfig = {
            apiUrl: window.location.origin,
            apiKey: 'test_widget_key',
            teamId: 'b2e30da5-e378-4e60-bb58-9d53ff0d30f0',
            position: 'bottom-right',
            buttonText: 'Report Bug',
            theme: 'auto',
            onIssueCreated: (issue) => {
                console.log('Issue created:', issue);
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { message: `Issue ${issue.identifier} created!`, type: 'success' }
                }));
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/turbowrap-issue-widget@1.0.6/dist/issue-widget.min.js" async></script>
</body>
</html>
