<!DOCTYPE html>
<html lang="it" x-data="{ sidebarOpen: true, darkMode: localStorage.getItem('darkMode') === 'true' }"
      :class="{ 'dark': darkMode }"
      x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TurboWrap{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/main.css">

    {% block head %}{% endblock %}
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <!-- Toast notifications -->
    <div id="toast-container"
         x-data="toastManager()"
         @show-toast.window="show($event.detail)"
         class="fixed top-4 right-4 z-50 space-y-2">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-8"
                 x-transition:enter-end="opacity-100 transform translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 :class="toast.type === 'error' ? 'bg-red-500' : 'bg-green-500'"
                 class="text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2">
                <span x-text="toast.message"></span>
                <button @click="toast.visible = false" class="ml-2 hover:opacity-75">&times;</button>
            </div>
        </template>
    </div>

    <!-- Layout -->
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        {% include "components/sidebar.html" %}

        <!-- Main content -->
        <main class="flex-1 overflow-auto transition-all duration-300"
              :class="sidebarOpen ? 'ml-64' : 'ml-16'">
            <div class="p-6">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Custom JS -->
    <script src="/static/js/app.js"></script>

    <!-- HTMX event handlers -->
    <script>
        document.body.addEventListener('showToast', function(evt) {
            window.dispatchEvent(new CustomEvent('show-toast', { detail: evt.detail }));
        });

        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.xhr.getResponseHeader('HX-Trigger')) {
                try {
                    const triggers = JSON.parse(evt.detail.xhr.getResponseHeader('HX-Trigger'));
                    if (triggers.showToast) {
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: triggers.showToast }));
                    }
                } catch(e) {}
            }
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
